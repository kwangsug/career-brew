<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì»¤ë¦¬ì–´ ë¸Œë£¨: ì‹œí¬ë¦¿</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; text-align: center; background: #fff; color: #333; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; box-sizing: border-box; touch-action: manipulation; height: 100vh; display: flex; align-items: center; justify-content: center; }
        * { box-sizing: border-box; }

        #game-container { 
            width: 100%; 
            max-width: 450px; 
            height: 100%; 
            max-height: 100vh;
            background: #fff; 
            padding: 15px; 
            position: relative; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        h1 { margin: 5px 0 10px 0; font-size: 22px; color: #3e2723; }

        canvas { border-radius: 12px; background: #d2b48c; cursor: pointer; width: 100%; touch-action: none; display: block; margin-bottom: 5px; -webkit-tap-highlight-color: transparent; flex-shrink: 0; }
        
        #ui { margin-bottom: 10px; padding: 12px; background: #faf3e0; border-radius: 15px; border: none; flex-shrink: 0; }
        
        .level-line { font-weight: bold; font-size: 15px; color: #3e2723; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        
        .stat-row { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
            font-size: 14px; 
            color: #5d4037; 
            margin-bottom: 5px; 
            gap: 10px;
        }

        .main-beans { font-size: 38px; color: #8b4513; margin: 8px 0 5px 0; font-weight: 900; word-break: keep-all; letter-spacing: -1px; line-height: 1.0; }
        
        .badge { padding: 3px 10px; border-radius: 20px; min-width: 70px; display: inline-block; text-align: center; border: 2px solid transparent; font-weight: 800; font-size: 13px; }
        .badge-click { background: #ffe0b2; color: #e65100; border-color: #ffb74d; }
        .badge-bps { background: #e0f2f1; color: #00695c; border-color: #4db6ac; }

        .store-header { text-align: left; margin: 5px 0 8px 0; font-size: 16px; font-weight: 800; color: #3e2723; border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }

        #upgrades { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 5px; 
            padding-bottom: 10px; 
            min-height: 150px; 
        }
        #upgrades::-webkit-scrollbar { width: 4px; }
        #upgrades::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 10px; }
        #upgrades::-webkit-scrollbar-track { background: #efebe9; }

        button { 
            background: #fff; border: 2px solid #eee; padding: 10px 12px 10px 15px; 
            cursor: pointer; border-radius: 10px; display: flex; justify-content: space-between; 
            transition: 0.1s; align-items: center; text-align: left; position: relative; overflow: visible; 
            min-height: 70px; height: auto; box-shadow: 0 2px 0 #e0e0e0; width: 100%; flex-shrink: 0;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 0 #ccc; }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 0 0; }
        button:disabled { background: #f9f9f9; color: #aaa; cursor: not-allowed; opacity: 1; border-color: #f0f0f0; box-shadow: none; }
        button.locked { background: #f5f5f5; border-color: #ddd; opacity: 0.7; }
        
        .btn-click { border-left: 6px solid #ff9800; }
        .btn-bps { border-left: 6px solid #009688; }
        .btn-locked { border-left: 6px solid #bdbdbd; }

        .item-info { display: flex; flex-direction: column; gap: 3px; z-index: 2; flex: 1; }
        .item-name { font-weight: 900; font-size: 15px; color: #222; letter-spacing: -0.5px; line-height: 1.2; }
        .item-cost { font-size: 12px; color: #5d4037; font-weight: 700; background: rgba(139, 69, 19, 0.08); padding: 2px 5px; border-radius: 4px; display: inline-block; width: fit-content; margin-top: 2px; }
        
        .item-right { text-align: right; min-width: 90px; display: flex; flex-direction: column; align-items: flex-end;}
        .item-effect { font-weight: 900; font-size: 13px; z-index: 2; text-shadow: 1px 1px 0 #fff; line-height: 1.2; word-break: break-all;}
        .item-lvl { font-size: 11px; color: #888; font-weight: bold; margin-bottom: 2px; }
        
        .rank-info { font-size: 12px; color: #8d6e63; margin-top: 5px; cursor: pointer; font-weight: bold; flex-shrink: 0; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 8px;}
        
        #toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 3000;}

        .footer-controls { margin-top: 8px; display: flex; justify-content: center; gap: 15px; align-items: center; flex-shrink: 0; padding-bottom: 5px;}
        .save-btn { background: #8d6e63; color: white; border: none; padding: 6px 12px; font-size: 12px; border-radius: 20px; box-shadow: none; min-height: 0; width: auto; display: inline-block;}
        .reset-btn { background: none; border: none; padding: 5px; font-size: 11px; color: #ccc; text-decoration: underline; cursor: pointer; min-height: 0; width: auto; box-shadow: none; display: inline-block; }
        .reset-btn:hover { color: #d32f2f; }
        
        #ranking-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; width:90%; max-width:380px; padding:25px; border-radius:20px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
    <h1>â˜• ì»¤ë¦¬ì–´ ë¸Œë£¨: ì‹œí¬ë¦¿</h1>
    
    <div id="ui">
        <div class="level-line">
            ì§ê¸‰: <span id="level" style="color:#d2691e; font-size:18px;">ì•Œë°”ìƒ</span>
        </div>
        
        <div class="stat-row">
            <span>ğŸ‘† í´ë¦­ë‹¹:</span>
            <span id="click-power" class="badge badge-click">1</span>
        </div>
        <div class="stat-row">
            <span>âš™ï¸ ì´ˆë‹¹:</span>
            <span id="bps" class="badge badge-bps">0</span>
        </div>

        <div class="main-beans"><span id="beans">0</span> ğŸ«˜</div>
        <div style="font-size: 12px; color: #8d6e63; font-weight: bold;">ì†ìœ¼ë¡œ ë³¶ì€ ì½©: <span id="manualTotal">0</span></div>
    </div>

    <canvas id="game" width="400" height="160"></canvas>

    <div class="store-header">
        <span>ğŸ›’ ìƒì </span>
        <span style="font-size:12px; font-weight:bold; color:#795548;">ì„±ì¥í•˜ì„¸ìš”!</span>
    </div>
    <div id="upgrades"></div>
    
    <div class="rank-info" onclick="showRanking()">
        ğŸ† <b>ì‹¤ì‹œê°„ ë­í‚¹</b> (ë‚´ ìˆœìœ„: <span id="my-rank-text" style="color:#d84315;">...</span>)
    </div>

    <div class="footer-controls">
        <button class="save-btn" onclick="saveGame(true)">ğŸ’¾ ìˆ˜ë™ ì €ì¥</button>
        <button class="reset-btn" onclick="resetGame()">ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="ranking-modal">
    <div class="modal-content">
        <h2 style="color:#3e2723; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ† ì‹¤ì‹œê°„ ë­í‚¹</h2>
        <div id="ranking-list"></div>
        <button onclick="closeRanking()" style="width:100%; justify-content:center; margin-top:20px; height:50px; font-size:18px; font-weight:bold; background:#3e2723; color:white; border:none; border-radius:10px;">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    let gameState = {
        beans: 0,
        baseBps: 0,
        baseClick: 1,
        manualTotal: 0,
        feverGauge: 0,
        isFever: false,
        lastTime: Date.now(),
        levels: ['ì•Œë°”ìƒ', 'ì£¼ì„', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬', 'CEO', 'ì»¤í”¼ ì¬ë²Œ', 'ì›ë‘ ì¥ê´€', 'ì§€êµ¬ ëŒ€í†µë ¹', 'íƒœì–‘ê³„ ê´€ë¦¬ì', 'ì€í•˜ê³„ ì§€ë°°ì', 'ìš°ì£¼ì˜ ì£¼ì¸', 'ì»¤í”¼ì˜ ì‹ ']
    };

    // [Ver 7.0 ë°¸ëŸ°ìŠ¤ ìœ ì§€]
    // 1. T1: 50 vs 100 (2ë°°)
    // 2. T11: 4í•´
    // 3. T12: 22í•´
    const items = [
        // [Tier 1] ì‹œì‘: ë”± 2ë°° (50 vs 100)
        { name: 'ğŸ§¤ ê³ ë¬´ ì¥ê°‘', type: 'click', basePrice: 50, val: 1, owned: 0 },
        { name: 'â˜• ëª¨ì¹´í¬íŠ¸', type: 'bps', basePrice: 100, val: 2, owned: 0 },
        
        // [Tier 2] ë„ì•½
        { name: 'ğŸ”¨ ì›ë‘ ë§ì¹˜', type: 'click', basePrice: 2000, val: 20, owned: 0 },
        { name: 'ğŸ”Œ ê°€ì •ìš© ë¨¸ì‹ ', type: 'bps', basePrice: 8000, val: 60, owned: 0 },
        
        // [Tier 3] ì „ë¬¸
        { name: 'ğŸ“ ë°”ë¦¬ìŠ¤íƒ€ 1ê¸‰', type: 'click', basePrice: 60000, val: 400, owned: 0 },
        { name: 'ğŸª í”„ëœì°¨ì´ì¦ˆ', type: 'bps', basePrice: 300000, val: 1500, owned: 0 },
        
        // [Tier 4] ê¸°ì—…
        { name: 'âš¡ ì „ê¸° ì¥ê°‘', type: 'click', basePrice: 2500000, val: 10000, owned: 0 },
        { name: 'ğŸ­ ìŠ¤ë§ˆíŠ¸ íŒ©í† ë¦¬', type: 'bps', basePrice: 15000000, val: 50000, owned: 0 },
        
        // [Tier 5] êµ­ê°€ (ì–µ ë‹¨ìœ„)
        { name: 'ğŸ¦¾ ì‚¬ì´ë³´ê·¸ íŒ”', type: 'click', basePrice: 200000000, val: 600000, owned: 0 }, 
        { name: 'ğŸš¢ ì›ë‘ ë¬´ì—­ì„ ', type: 'bps', basePrice: 1200000000, val: 3000000, owned: 0 },
        
        // [Tier 6] ê¸€ë¡œë²Œ (ë°±ì–µ ~ ì²œì–µ)
        { name: 'ğŸ§¬ ëŒì—°ë³€ì´ ì†', type: 'click', basePrice: 30000000000, val: 70000000, owned: 0 }, 
        { name: 'ğŸ™ï¸ ì»¤í”¼ ì œêµ­ ë³¸ì‚¬', type: 'bps', basePrice: 180000000000, val: 400000000, owned: 0 },
        
        // [Tier 7] ë¯¸ë˜ (ì¡° ë‹¨ìœ„)
        { name: 'ğŸ§  ë‡ŒíŒŒ ë¡œìŠ¤íŒ…', type: 'click', basePrice: 3000000000000, val: 6000000000, owned: 0 }, 
        { name: 'ğŸ¤– AI êµ°ë‹¨', type: 'bps', basePrice: 20000000000000, val: 35000000000, owned: 0 },
        
        // [Tier 8] ì§€êµ¬ (ë°±ì¡° ~ ì²œì¡°)
        { name: 'ğŸŒ‹ ë§ˆê·¸ë§ˆ í„°ì¹˜', type: 'click', basePrice: 350000000000000, val: 700000000000, owned: 0 }, 
        { name: 'ğŸŒ§ï¸ ì¸ê³µê°•ìš° ìœ„ì„±', type: 'bps', basePrice: 2000000000000000, val: 3500000000000, owned: 0 }, 
        
        // [Tier 9] ìš°ì£¼ (ê²½ ë‹¨ìœ„ ì§„ì…)
        { name: 'â˜„ï¸ ìœ ì„±ìš° íƒ€ê²©', type: 'click', basePrice: 30000000000000000, val: 50000000000000, owned: 0 }, // 3ê²½
        { name: 'ğŸŒ• ë‹¬í‘œë©´ ê±´ì¡°ì¥', type: 'bps', basePrice: 150000000000000000, val: 200000000000000, owned: 0 }, // 15ê²½
        
        // [Tier 10] íƒœì–‘ (ì²œê²½)
        { name: 'â˜€ï¸ íƒœì–‘ê¶Œ í€ì¹˜', type: 'click', basePrice: 1000000000000000000, val: 1500000000000000, owned: 0 }, // 1000ê²½
        { name: 'â˜¢ï¸ í•µìœµí•© ë³´ì¼ëŸ¬', type: 'bps', basePrice: 5000000000000000000, val: 8000000000000000, owned: 0 }, // 5000ê²½
        
        // [Tier 11] ì€í•˜ (4í•´)
        { name: 'ğŸŒ€ ì›Œí”„ í´ë¦­', type: 'click', basePrice: 10000000000000000000, val: 20000000000000000, owned: 0 }, // 1í•´
        { name: 'ğŸ•³ï¸ ë¸”ë™í™€ ë¶„ì‡„ê¸°', type: 'bps', basePrice: 40000000000000000000, val: 40000000000000000, owned: 0 }, // â˜… 4í•´
        
        // [Tier 12] ì‹  (22í•´)
        { name: 'âœ¨ í˜„ì‹¤ ì¡°ì‘', type: 'click', basePrice: 80000000000000000000, val: 60000000000000000, owned: 0 }, // 8í•´
        { name: 'ğŸ’¥ ë¹…ë±… ë¡œìŠ¤í„°', type: 'bps', basePrice: 220000000000000000000, val: 250000000000000000, owned: 0 } // â˜… 22í•´
    ];

    const competitors = [
        { name: "ì€í•˜ê³„ ì»¤í”¼ ì—°í•©", bps: 300000000000000000000 }, // 30í•´
        { name: "ì¼ë¡  ë¨¸ìŠ¤í¬", bps: 5000000000 }, 
        { name: "ì—­ì‚¼ë™ ì¹´ëˆ„ ì¥ì¸", bps: 4000 },
        { name: "ì˜†ì§‘ ìŠ¤íƒ€ë²…ìŠ¤", bps: 8000 }
    ];

    function formatNum(num) {
        num = Math.floor(num); 
        if (num < 10000) return num.toLocaleString();

        const units = ["", "ë§Œ", "ì–µ", "ì¡°", "ê²½", "í•´"];
        let unitIndex = Math.floor(Math.log10(num) / 4);
        
        if (unitIndex >= units.length) unitIndex = units.length - 1;

        const majorUnitVal = Math.pow(10000, unitIndex);
        const majorNum = Math.floor(num / majorUnitVal);
        const minorNum = Math.floor((num % majorUnitVal) / (majorUnitVal / 10000));

        let result = `${majorNum}${units[unitIndex]}`;
        if (minorNum > 0 && unitIndex > 0) {
            result += ` ${minorNum}${units[unitIndex - 1]}`;
        }
        return result;
    }

    let particles = [];

    function saveGame(showToast = false) {
        const saveData = {
            gameState: {
                beans: gameState.beans,
                manualTotal: gameState.manualTotal,
                lastTime: Date.now()
            },
            items: items.map(item => ({ name: item.name, owned: item.owned }))
        };
        // ë°¸ëŸ°ìŠ¤(ìˆœì„œ í‘œì‹œ) ë³€ê²½ìœ¼ë¡œ í‚¤ ì—…ë°ì´íŠ¸ V8
        localStorage.setItem('careerBrewSaveV8', JSON.stringify(saveData)); 
        if (showToast) {
            const toast = document.getElementById('toast');
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 1500);
        }
    }

    function loadGame() {
        const savedString = localStorage.getItem('careerBrewSaveV8');
        if (savedString) {
            try {
                const savedData = JSON.parse(savedString);
                if (savedData.gameState) {
                    gameState.beans = savedData.gameState.beans || 0;
                    gameState.manualTotal = savedData.gameState.manualTotal || 0;
                }
                if (savedData.items) {
                    savedData.items.forEach(savedItem => {
                        const item = items.find(i => i.name === savedItem.name);
                        if (item) item.owned = savedItem.owned;
                    });
                }
                recalculateStats();

                if (savedData.gameState.lastTime) {
                    const now = Date.now();
                    const secondsPassed = (now - savedData.gameState.lastTime) / 1000;
                    if (secondsPassed > 60) { 
                        const offlineEarnings = gameState.baseBps * secondsPassed;
                        if (offlineEarnings > 0) {
                            gameState.beans += offlineEarnings;
                            alert(`â˜• ì—…ë¬´ ë³µê·€ í™˜ì˜í•©ë‹ˆë‹¤!\në¶€ì¬ì¤‘ ${formatNum(offlineEarnings)}ê°œì˜ ì½©ì´ ìƒì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                    }
                }
            } catch (e) {
                console.error("ë¡œë“œ ì‹¤íŒ¨", e);
            }
        }
    }

    function recalculateStats() {
        gameState.baseBps = 0;
        gameState.baseClick = 1;
        items.forEach(item => {
            if (item.type === 'click') gameState.baseClick += item.val * item.owned;
            else gameState.baseBps += item.val * item.owned;
        });
    }

    function resetGame() {
        if (confirm("âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            localStorage.removeItem('careerBrewSaveV8');
            location.reload();
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (gameState.baseBps > 1e8 || gameState.baseClick > 1e8) {
            ctx.fillStyle = '#0d1b2a'; 
            ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            for(let i=0; i<20; i++) {
                ctx.globalAlpha = Math.random();
                ctx.fillRect(Math.random()*400, Math.random()*300, 2, 2);
            }
            ctx.globalAlpha = 1.0;
        } else {
            ctx.fillStyle = gameState.isFever ? '#fff9c4' : '#d2b48c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        ctx.save();
        if(gameState.isFever) {
            ctx.shadowBlur = 30;
            ctx.shadowColor = "#ffeb3b";
        }
        ctx.fillStyle = gameState.isFever ? '#ff5722' : '#6d4c41';
        ctx.beginPath();
        ctx.roundRect(50, 40, 300, 100, 20);
        ctx.fill();
        ctx.restore();

        particles.forEach((p, i) => {
            ctx.fillStyle = (gameState.baseBps > 1e8) ? `rgba(255, 255, 255, ${p.life})` : `rgba(62, 39, 35, ${p.life})`;
            ctx.beginPath(); ctx.arc(p.x, p.y, 7, 0, Math.PI*2); ctx.fill();
            p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.03;
            if (p.life <= 0) particles.splice(i, 1);
        });

        // ê²Œì´ì§€ ë°”
        ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.fillRect(50, 145, 300, 10);
        ctx.fillStyle = gameState.isFever ? '#d50000' : '#fb8c00';
        ctx.fillRect(50, 145, 300 * (gameState.feverGauge/100), 10);
        
        ctx.fillStyle = (gameState.baseBps > 1e8) ? '#fff' : 'rgba(255,255,255,0.8)'; 
        ctx.font = '900 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(gameState.isFever ? "ğŸ”¥ FEVER MODE (x10) ğŸ”¥" : "CLICK TO ROAST", 200, 95);
        ctx.textAlign = 'start';
    }

    function handleInput(e) {
        e.preventDefault(); 
        const rect = canvas.getBoundingClientRect();
        const points = e.changedTouches ? e.changedTouches : [{clientX: e.clientX, clientY: e.clientY}];

        for (let i = 0; i < points.length; i++) {
            const p = points[i];
            const x = (p.clientX - rect.left) * (canvas.width / rect.width);
            const y = (p.clientY - rect.top) * (canvas.height / rect.height);

            if (x > 0 && x < 400 && y > 0 && y < 160) {
                const multiplier = gameState.isFever ? 10 : 1;
                const clickGain = gameState.baseClick * multiplier;
                
                gameState.beans += clickGain;
                gameState.manualTotal += clickGain;
                
                if (!gameState.isFever) {
                    gameState.feverGauge = Math.min(100, gameState.feverGauge + 2);
                    if (gameState.feverGauge >= 100) startFever();
                }

                for(let j=0; j<6; j++) {
                    particles.push({x: x, y: y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, life:1});
                }
            }
        }
    }

    canvas.addEventListener('touchstart', handleInput, {passive: false});
    canvas.addEventListener('mousedown', handleInput);

    function startFever() {
        gameState.isFever = true;
        const fInter = setInterval(() => {
            gameState.feverGauge -= 1.0;
            if (gameState.feverGauge <= 0) {
                gameState.isFever = false;
                gameState.feverGauge = 0;
                clearInterval(fInter);
            }
        }, 50);
    }

    function updateStore() {
        const upgradesDiv = document.getElementById('upgrades');
        upgradesDiv.innerHTML = '';
        
        let nextLockedShown = false; // "ë‹¤ìŒ ì ê¸´ ì•„ì´í…œ"ì„ í•˜ë‚˜ ë³´ì—¬ì¤¬ëŠ”ì§€ ì²´í¬

        items.forEach((item, index) => {
            // ê°€ê²© ê³„ì‚°
            const price = Math.floor(item.basePrice * Math.pow(1.15, item.owned));
            
            // ì ê¸ˆ ìƒíƒœ í™•ì¸
            let isLocked = false;
            if (index > 0 && items[index-1].owned === 0) {
                isLocked = true;
            }

            // [ë¸”ë¼ì¸ë“œ ë¡œì§]
            // ì´ë¯¸ ì ê¸´ ì•„ì´í…œì„ í•˜ë‚˜ ê·¸ë ¸ë‹¤ë©´, ê·¸ ë’¤ì— ìˆëŠ” ì•„ì´í…œë“¤ì€ ì•„ì˜ˆ ê·¸ë¦¬ì§€ ì•Šê³  ì¢…ë£Œ
            if (isLocked) {
                if (nextLockedShown) return; // ì´ë¯¸ ë‹¤ìŒ ë‹¨ê³„(ë¯¸ë˜)ë¥¼ í•˜ë‚˜ ë³´ì—¬ì¤¬ìœ¼ë¯€ë¡œ ë’¤ëŠ” ìˆ¨ê¹€
                nextLockedShown = true; // ì´ì œ í•˜ë‚˜ ë³´ì—¬ì¤€ë‹¤ê³  ì²´í¬í•¨
            }

            const btn = document.createElement('button');
            
            const isClickItem = item.type === 'click';
            let btnClass = isClickItem ? 'btn-click' : 'btn-bps';
            if (isLocked) btnClass = 'btn-locked';

            btn.className = btnClass;
            btn.disabled = isLocked || (gameState.beans < price);
            if (isLocked) btn.classList.add('locked');

            const effectColor = isClickItem ? '#e65100' : '#00695c';
            const typeIcon = isClickItem ? 'ğŸ‘†' : 'âš™ï¸';
            const unitText = isClickItem ? '/í´ë¦­' : '/ì´ˆ';

            let displayName = `${typeIcon} ${item.name}`;
            let displayCost = `ë¹„ìš©: ${formatNum(price)} ğŸ«˜`;
            let displayOwned = `Lv. ${item.owned}`;
            let displayEffect = `+${formatNum(item.val)}${unitText}`;
            let displayEffectStyle = `color:${effectColor}`;

            if (isLocked) {
                displayEffect = "???";
                displayEffectStyle = "color:#999";
            }

            btn.innerHTML = `
                <div class="item-info">
                    <span class="item-name">${displayName}</span>
                    <span class="item-cost">${displayCost}</span>
                </div>
                <div class="item-right">
                    <div class="item-lvl">${displayOwned}</div>
                    <div class="item-effect" style="${displayEffectStyle}">${displayEffect}</div>
                </div>
            `;
            
            btn.onclick = (e) => {
                if (isLocked) return;

                if (gameState.beans >= price) {
                    gameState.beans -= price;
                    item.owned++;
                    if (item.type === 'click') {
                        gameState.baseClick += item.val;
                    } else {
                        gameState.baseBps += item.val;
                    }
                    updateStore(); 
                    saveGame();
                }
            };
            upgradesDiv.appendChild(btn);
        });
    }

    function showRanking() {
        const modal = document.getElementById('ranking-modal');
        const list = document.getElementById('ranking-list');
        const currentBps = gameState.baseBps * (gameState.isFever ? 10 : 1);
        
        const allRanks = [...competitors, { name: "ë‚˜ (í”Œë ˆì´ì–´)", bps: currentBps }]
            .sort((a, b) => b.bps - a.bps);

        list.innerHTML = allRanks.map((p, i) => `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-weight:${p.name==="ë‚˜ (í”Œë ˆì´ì–´)"?'bold':'normal'}; color:${p.name==="ë‚˜ (í”Œë ˆì´ì–´)"?'#d84315':'#555'}">
                <span>${i+1}ìœ„. ${p.name}</span>
                <span>${formatNum(p.bps)} BPS</span>
            </div>
        `).join('');
        modal.style.display = 'flex';
    }

    function closeRanking() { document.getElementById('ranking-modal').style.display = 'none'; }

    setInterval(() => {
        if (!gameState.isFever && gameState.feverGauge > 0) {
            gameState.feverGauge = Math.max(0, gameState.feverGauge - 0.5);
        }
    }, 100);

    function gameLoop() {
        const now = Date.now();
        const delta = (now - gameState.lastTime) / 1000;
        gameState.lastTime = now;

        const multiplier = gameState.isFever ? 10 : 1;
        const currentBps = gameState.baseBps * multiplier;
        const currentClick = gameState.baseClick * multiplier;
        
        gameState.beans += currentBps * delta;
        
        document.getElementById('beans').textContent = formatNum(gameState.beans);
        
        const bpsBadge = document.getElementById('bps');
        const clickBadge = document.getElementById('click-power');
        
        bpsBadge.textContent = formatNum(currentBps);
        clickBadge.textContent = formatNum(currentClick);

        if(gameState.isFever) {
            const shake = `scale(${1 + Math.sin(now/50)*0.1})`;
            bpsBadge.parentElement.style.color = '#d50000';
            bpsBadge.style.transform = shake;
            clickBadge.style.transform = shake;
        } else {
            bpsBadge.parentElement.style.color = '#5d4037';
            bpsBadge.style.transform = 'scale(1)';
            clickBadge.style.transform = 'scale(1)';
        }

        document.getElementById('manualTotal').textContent = formatNum(gameState.manualTotal);
        
        const score = Math.max(gameState.baseBps, gameState.baseClick);
        if (score > 0) {
            const levelIndex = Math.min(Math.floor(Math.log10(score)), gameState.levels.length - 1);
            if (levelIndex >= 0) document.getElementById('level').textContent = gameState.levels[levelIndex];
        }

        const myRank = [...competitors, {bps: currentBps}].sort((a,b)=>b.bps-a.bps).findIndex(p => p.bps === currentBps) + 1;
        document.getElementById('my-rank-text').textContent = `${myRank}ìœ„`;

        // ìƒì  ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (disable/enable)
        // ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ëœ ë²„íŠ¼ë“¤ì€ DOMì— ì•„ì˜ˆ ì—†ìœ¼ë¯€ë¡œ ìˆëŠ” ê²ƒë“¤ë§Œ ì—…ë°ì´íŠ¸
        const buttons = document.querySelectorAll('#upgrades button');
        // ì£¼ì˜: ë²„íŠ¼ ê°œìˆ˜ëŠ” items ê°œìˆ˜ë³´ë‹¤ ì ì„ ìˆ˜ ìˆìŒ (ë¸”ë¼ì¸ë“œ ë•Œë¬¸)
        // ë”°ë¼ì„œ itemsë¥¼ ìˆœíšŒí•˜ë©´ì„œ ë²„íŠ¼ ì¸ë±ìŠ¤ë¥¼ ë”°ë¡œ ê´€ë¦¬í•´ì•¼ í•¨
        
        let btnIdx = 0;
        let nextLockedShown = false;

        items.forEach((item, i) => {
            let isLocked = false;
            if (i > 0 && items[i-1].owned === 0) {
                isLocked = true;
            }

            // ë¸”ë¼ì¸ë“œ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ìˆœíšŒí•´ì•¼ ë²„íŠ¼ ë§¤ì¹­ì´ ë¨
            if (isLocked) {
                if (nextLockedShown) return; 
                nextLockedShown = true;
            }

            // ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ë©´ í™”ë©´ì— ë²„íŠ¼ì´ ì¡´ì¬í•¨
            if (buttons[btnIdx]) {
                const price = Math.floor(item.basePrice * Math.pow(1.15, item.owned));
                buttons[btnIdx].disabled = isLocked || (gameState.beans < price);
            }
            btnIdx++;
        });

        draw();
        requestAnimationFrame(gameLoop);
    }

    loadGame();
    updateStore();
    gameLoop();

    setInterval(() => { saveGame(); }, 10000);
    window.addEventListener('beforeunload', () => { saveGame(); });
</script>
</body>
</html>
