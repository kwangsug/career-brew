<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì»¤ë¦¬ì–´ ë¸Œë£¨: ì§€ê·¸ì¬ê·¸ (ì˜¨ë¼ì¸)</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; text-align: center; background: #fff; color: #333; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; box-sizing: border-box; touch-action: manipulation; height: 100vh; display: flex; align-items: center; justify-content: center; }
        * { box-sizing: border-box; }

        #game-container { 
            width: 100%; max-width: 450px; height: 100%; max-height: 100vh;
            background: #fff; padding: 15px; position: relative; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        h1 { margin: 5px 0 10px 0; font-size: 22px; color: #3e2723; }

        canvas { border-radius: 12px; background: #faf3e0; cursor: pointer; width: 100%; touch-action: none; display: block; margin-bottom: 5px; -webkit-tap-highlight-color: transparent; flex-shrink: 0; box-shadow: inset 0 0 20px rgba(139, 69, 19, 0.1); }
        
        #ui { margin-bottom: 10px; padding: 12px; background: #faf3e0; border-radius: 15px; border: none; flex-shrink: 0; }
        .level-line { font-weight: bold; font-size: 15px; color: #3e2723; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .stat-row { display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 14px; color: #5d4037; margin-bottom: 5px; gap: 10px; }
        .main-beans { font-size: 38px; color: #8b4513; margin: 8px 0 5px 0; font-weight: 900; word-break: keep-all; letter-spacing: -1px; line-height: 1.0; }
        
        .badge { padding: 3px 10px; border-radius: 20px; min-width: 70px; display: inline-block; text-align: center; border: 2px solid transparent; font-weight: 800; font-size: 13px; }
        .badge-click { background: #ffe0b2; color: #e65100; border-color: #ffb74d; }
        .badge-bps { background: #e0f2f1; color: #00695c; border-color: #4db6ac; }

        .store-header { text-align: left; margin: 5px 0 8px 0; font-size: 16px; font-weight: 800; color: #3e2723; border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #upgrades { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 10px; min-height: 150px; }
        #upgrades::-webkit-scrollbar { width: 4px; }
        #upgrades::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 10px; }

        button { background: #fff; border: 2px solid #eee; padding: 10px 12px 10px 15px; cursor: pointer; border-radius: 10px; display: flex; justify-content: space-between; transition: 0.1s; align-items: center; text-align: left; position: relative; overflow: visible; min-height: 70px; height: auto; box-shadow: 0 2px 0 #e0e0e0; width: 100%; flex-shrink: 0; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 0 #ccc; }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 0 0; }
        button:disabled { background: #f9f9f9; color: #aaa; cursor: not-allowed; opacity: 1; border-color: #f0f0f0; box-shadow: none; }
        button.locked { background: #f5f5f5; border-color: #ddd; opacity: 0.7; }
        
        .btn-click { border-left: 6px solid #ff9800; }
        .btn-bps { border-left: 6px solid #009688; }
        .btn-locked { border-left: 6px solid #bdbdbd; }

        .item-info { display: flex; flex-direction: column; gap: 3px; z-index: 2; flex: 1; }
        .item-name { font-weight: 900; font-size: 15px; color: #222; letter-spacing: -0.5px; line-height: 1.2; }
        .item-cost { font-size: 12px; color: #5d4037; font-weight: 700; background: rgba(139, 69, 19, 0.08); padding: 2px 5px; border-radius: 4px; display: inline-block; width: fit-content; }
        .item-right { text-align: right; min-width: 90px; display: flex; flex-direction: column; align-items: flex-end;}
        .item-effect { font-weight: 900; font-size: 13px; z-index: 2; text-shadow: 1px 1px 0 #fff; line-height: 1.2; word-break: break-all;}
        .item-lvl { font-size: 11px; color: #888; font-weight: bold; }
        
        .rank-info { font-size: 12px; color: #8d6e63; margin-top: 5px; cursor: pointer; font-weight: bold; flex-shrink: 0; text-align: center; padding: 8px; background: #f5f5f5; border-radius: 8px;}
        #toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 3000;}

        .footer-controls { margin-top: 8px; display: flex; justify-content: center; gap: 15px; align-items: center; flex-shrink: 0; padding-bottom: 5px;}
        .save-btn { background: #8d6e63; color: white; border: none; padding: 6px 12px; font-size: 12px; border-radius: 20px; box-shadow: none; min-height: 0; width: auto; display: inline-block;}
        .reset-btn { background: none; border: none; padding: 5px; font-size: 11px; color: #ccc; text-decoration: underline; cursor: pointer; min-height: 0; width: auto; box-shadow: none; display: inline-block; }

        /* ë­í‚¹ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #ranking-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; width:90%; max-width:380px; padding:25px; border-radius:20px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .tab-container { display: flex; justify-content: space-around; margin-bottom: 15px; border-bottom: 2px solid #eee; }
        .tab-btn { background: none; border: none; padding: 10px; font-weight: bold; color: #888; cursor: pointer; flex: 1; border-bottom: 3px solid transparent; box-shadow: none; min-height: 40px; border-radius: 0; }
        .tab-btn.active { color: #3e2723; border-bottom-color: #3e2723; }
        .rank-list-container { max-height: 300px; overflow-y: auto; text-align: left; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .rank-item.my-rank { background: #fff3e0; border-radius: 8px; font-weight: bold; color: #d84315; border: 1px solid #ffe0b2; }
        .rank-badge { width: 24px; display: inline-block; text-align: center; font-weight: bold; color: #8d6e63; margin-right: 5px; }
        .top-3 { color: #fbc02d; text-shadow: 1px 1px 0 #fff9c4; font-size: 16px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
    <h1>â˜• ì»¤ë¦¬ì–´ ë¸Œë£¨: ì§€ê·¸ì¬ê·¸</h1>
    
    <div id="ui">
        <div class="level-line">
            <span id="player-name" style="font-size:14px; color:#555; margin-right:5px;"></span>
            ì§ê¸‰: <span id="level" style="color:#d2691e; font-size:18px;">ì•Œë°”ìƒ</span>
        </div>
        
        <div class="stat-row">
            <span>ğŸ‘† í´ë¦­ë‹¹:</span>
            <span id="click-power" class="badge badge-click">1</span>
        </div>
        <div class="stat-row">
            <span>âš™ï¸ ì´ˆë‹¹:</span>
            <span id="bps" class="badge badge-bps">0</span>
        </div>

        <div class="main-beans"><span id="beans">0</span> ğŸ«˜</div>
        <div style="font-size: 12px; color: #8d6e63; font-weight: bold;">ì†ìœ¼ë¡œ ë³¶ì€ ì½©: <span id="manualTotal">0</span></div>
    </div>

    <canvas id="game" width="400" height="180"></canvas>

    <div class="store-header">
        <span>ğŸ›’ ìƒì </span>
        <span style="font-size:12px; font-weight:bold; color:#795548;">ì„±ì¥í•˜ì„¸ìš”!</span>
    </div>
    <div id="upgrades"></div>
    
    <div class="rank-info" onclick="window.showRanking()">
        ğŸ† <b>ì‹¤ì‹œê°„ ë­í‚¹</b> (í™•ì¸í•˜ê¸°)
    </div>

    <div class="footer-controls">
        <button class="save-btn" onclick="window.saveGame(true)">ğŸ’¾ ì €ì¥ & ë­í‚¹ë“±ë¡</button>
        <button class="reset-btn" onclick="window.resetGame()">ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="ranking-modal">
    <div class="modal-content">
        <h2 style="color:#3e2723; margin-top:0; margin-bottom:10px;">ğŸ† ì‹¤ì‹œê°„ ë­í‚¹</h2>
        
        <div class="tab-container">
            <button class="tab-btn active" onclick="window.switchRankTab('national')">ğŸŒ ì „êµ­ (ì‹¤ì‹œê°„)</button>
            <button class="tab-btn" onclick="window.switchRankTab('regional')">ğŸ˜ï¸ ì§€ì—­ (ê°€ìƒ)</button>
            <button class="tab-btn" onclick="window.switchRankTab('friend')">ğŸ‘¥ ì¹œêµ¬ (ê°€ìƒ)</button>
        </div>

        <div id="rank-list-national" class="rank-list-container">ë¡œë”©ì¤‘...</div>
        <div id="rank-list-regional" class="rank-list-container" style="display:none;"></div>
        <div id="rank-list-friend" class="rank-list-container" style="display:none;"></div>

        <button onclick="window.closeRanking()" style="width:100%; margin-top:15px; height:45px; font-size:16px; font-weight:bold; background:#3e2723; color:white; border:none; border-radius:10px; cursor:pointer;">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    // [ì¤‘ìš”] ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” CDN ì£¼ì†Œë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    // ì‚¬ìš©ìë¶„ì˜ Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyD3mv9F87KSAJzuk0VYReg7aQfCQ7ak7ko",
      authDomain: "career-brew.firebaseapp.com",
      projectId: "career-brew",
      storageBucket: "career-brew.firebasestorage.app",
      messagingSenderId: "48722044572",
      appId: "1:48722044572:web:858470248dee6aab42ef59",
      measurementId: "G-5MLYRT46P4"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);

    console.log("ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ!");

    // ì „ì—­ ë³€ìˆ˜ë¡œ í• ë‹¹ (HTMLì—ì„œ ë²„íŠ¼ í´ë¦­ ì‹œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
    window.db = db;
    window.collection = collection;
    window.doc = doc;
    window.setDoc = setDoc;
    window.getDocs = getDocs;
    window.query = query;
    window.orderBy = orderBy;
    window.limit = limit;

    // --- ê²Œì„ ë¡œì§ ì‹œì‘ ---
    
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const beanImg = new Image();
    beanImg.src = "https://cdn-icons-png.flaticon.com/512/751/751663.png";

    let gameState = {
        beans: 0,
        baseBps: 0,
        baseClick: 1,
        manualTotal: 0,
        feverGauge: 0,
        isFever: false,
        lastTime: Date.now(),
        clickScale: 1.0,
        playerName: "ìµëª…",
        playerId: "",
        levels: ['ì•Œë°”ìƒ', 'ì£¼ì„', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬', 'CEO', 'ì»¤í”¼ ì¬ë²Œ', 'ì›ë‘ ì¥ê´€', 'ì§€êµ¬ ëŒ€í†µë ¹', 'íƒœì–‘ê³„ ê´€ë¦¬ì', 'ì€í•˜ê³„ ì§€ë°°ì', 'ìš°ì£¼ì˜ ì£¼ì¸', 'ì»¤í”¼ì˜ ì‹ ']
    };

    // ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ (Tier 16)
    const items = [
        { name: 'ğŸ§¤ ê³ ë¬´ ì¥ê°‘', type: 'bps', basePrice: 50, val: 1, owned: 0 }, 
        { name: 'â˜• ëª¨ì¹´í¬íŠ¸', type: 'click', basePrice: 200, val: 3, owned: 0 },
        { name: 'ğŸ”Œ ê°€ì •ìš© ë¨¸ì‹ ', type: 'bps', basePrice: 2000, val: 20, owned: 0 }, 
        { name: 'ğŸ”¨ ì›ë‘ ë§ì¹˜', type: 'click', basePrice: 8000, val: 60, owned: 0 }, 
        { name: 'ğŸª í”„ëœì°¨ì´ì¦ˆ', type: 'bps', basePrice: 60000, val: 400, owned: 0 }, 
        { name: 'ğŸ“ ë°”ë¦¬ìŠ¤íƒ€ 1ê¸‰', type: 'click', basePrice: 250000, val: 1200, owned: 0 }, 
        { name: 'ğŸ­ ìŠ¤ë§ˆíŠ¸ íŒ©í† ë¦¬', type: 'bps', basePrice: 2000000, val: 10000, owned: 0 },
        { name: 'âš¡ ì „ê¸° ì¥ê°‘', type: 'click', basePrice: 8000000, val: 30000, owned: 0 }, 
        { name: 'ğŸš¢ ì›ë‘ ë¬´ì—­ì„ ', type: 'bps', basePrice: 80000000, val: 250000, owned: 0 }, 
        { name: 'ğŸ¦¾ ì‚¬ì´ë³´ê·¸ íŒ”', type: 'click', basePrice: 320000000, val: 750000, owned: 0 }, 
        { name: 'ğŸ™ï¸ ì»¤í”¼ ì œêµ­ ë³¸ì‚¬', type: 'bps', basePrice: 3000000000, val: 6000000, owned: 0 }, 
        { name: 'ğŸ§¬ ëŒì—°ë³€ì´ ì†', type: 'click', basePrice: 12000000000, val: 18000000, owned: 0 }, 
        { name: 'ğŸ¤– AI êµ°ë‹¨', type: 'bps', basePrice: 100000000000, val: 150000000, owned: 0 }, 
        { name: 'ğŸ§  ë‡ŒíŒŒ ë¡œìŠ¤íŒ…', type: 'click', basePrice: 400000000000, val: 450000000, owned: 0 }, 
        { name: 'ğŸŒ§ï¸ ì¸ê³µê°•ìš° ìœ„ì„±', type: 'bps', basePrice: 5000000000000, val: 4000000000, owned: 0 }, 
        { name: 'ğŸŒ‹ ë§ˆê·¸ë§ˆ í„°ì¹˜', type: 'click', basePrice: 20000000000000, val: 12000000000, owned: 0 }, 
        { name: 'ğŸŒ• ë‹¬í‘œë©´ ê±´ì¡°ì¥', type: 'bps', basePrice: 250000000000000, val: 100000000000, owned: 0 }, 
        { name: 'â˜„ï¸ ìœ ì„±ìš° íƒ€ê²©', type: 'click', basePrice: 1000000000000000, val: 300000000000, owned: 0 }, 
        { name: 'â˜¢ï¸ í•µìœµí•© ë³´ì¼ëŸ¬', type: 'bps', basePrice: 15000000000000000, val: 3000000000000, owned: 0 },
        { name: 'â˜€ï¸ íƒœì–‘ê¶Œ í€ì¹˜', type: 'click', basePrice: 60000000000000000, val: 9000000000000, owned: 0 },
        { name: 'ğŸ•³ï¸ ë¸”ë™í™€ ë¶„ì‡„ê¸°', type: 'bps', basePrice: 1000000000000000000, val: 80000000000000, owned: 0 }, 
        { name: 'ğŸŒ€ ì›Œí”„ í´ë¦­', type: 'click', basePrice: 4000000000000000000, val: 240000000000000, owned: 0 }, 
        { name: 'ğŸ’¥ ë¹…ë±… ë¡œìŠ¤í„°', type: 'bps', basePrice: 80000000000000000000, val: 2000000000000000, owned: 0 }, 
        { name: 'âœ¨ í˜„ì‹¤ ì¡°ì‘', type: 'click', basePrice: 320000000000000000000, val: 6000000000000000, owned: 0 },
        // [Tier 13]
        { name: 'â³ íƒ€ì„ë¨¸ì‹  ë°°ë‹¬', type: 'bps', basePrice: 50000000000000000000000, val: 800000000000000000, owned: 0 }, 
        { name: 'ğŸ•°ï¸ ì‹œê°„ ì—­í–‰', type: 'click', basePrice: 200000000000000000000000, val: 2400000000000000000, owned: 0 }, 
        // [Tier 14]
        { name: 'ğŸŒŒ ë©€í‹°ë²„ìŠ¤ ì²´ì¸ì ', type: 'bps', basePrice: 40000000000000000000000000, val: 500000000000000000000, owned: 0 }, 
        { name: 'ğŸ‘¥ ë„í”Œê°±ì–´ ì¼ê¾¼', type: 'click', basePrice: 160000000000000000000000000, val: 1500000000000000000000, owned: 0 }, 
        // [Tier 15]
        { name: 'ğŸ’­ ì´ë°ì•„ ë¡œìŠ¤íŒ…', type: 'bps', basePrice: 30000000000000000000000000000, val: 600000000000000000000000, owned: 0 }, 
        { name: 'â™¾ï¸ ë¬´í•œì˜ ìˆŸê°€ë½', type: 'click', basePrice: 120000000000000000000000000000, val: 1800000000000000000000000, owned: 0 }, 
        // [Tier 16]
        { name: 'ğŸ’» ê°œë°œì ì½˜ì†”', type: 'bps', basePrice: 50000000000000000000000000000000, val: 1000000000000000000000000000, owned: 0 }, 
        { name: 'ğŸ‘‘ ê²Œì„ì˜ ì‹ ', type: 'click', basePrice: 200000000000000000000000000000000, val: 30000000000000000000000000000, owned: 0 }
    ];

    function formatNum(num) {
        num = Math.floor(num); 
        if (num < 10000) return num.toLocaleString();
        const units = ["", "ë§Œ", "ì–µ", "ì¡°", "ê²½", "í•´", "ì", "ì–‘", "êµ¬", "ê°„", "ì •", "ì¬", "ê·¹"];
        let unitIndex = Math.floor(Math.log10(num) / 4);
        if (unitIndex >= units.length) unitIndex = units.length - 1;
        const majorUnitVal = Math.pow(10000, unitIndex);
        const majorNum = Math.floor(num / majorUnitVal);
        const minorNum = Math.floor((num % majorUnitVal) / (majorUnitVal / 10000));
        let result = `${majorNum}${units[unitIndex]}`;
        if (minorNum > 0 && unitIndex > 0) result += ` ${minorNum}${units[unitIndex - 1]}`;
        return result;
    }

    let particles = [];
    let floatingTexts = [];

    // [Firebase] ì ìˆ˜ ì €ì¥ í•¨ìˆ˜
    async function saveScoreToFirebase() {
        if(!window.db) return;
        const score = gameState.baseBps * (gameState.isFever ? 10 : 1);
        try {
            // 'leaderboard' ì»¬ë ‰ì…˜ì— ë‚´ IDë¡œ ë¬¸ì„œë¥¼ ë§Œë“­ë‹ˆë‹¤ (ë®ì–´ì“°ê¸°)
            await window.setDoc(window.doc(window.db, "leaderboard", gameState.playerId), {
                name: gameState.playerName,
                score: score,
                timestamp: Date.now()
            });
            console.log("ğŸ”¥ ì„œë²„ì— ì ìˆ˜ ì €ì¥ ì™„ë£Œ:", score);
        } catch (e) {
            console.error("ğŸ”¥ ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    window.saveGame = function(showToast = false) {
        const saveData = {
            gameState: {
                beans: gameState.beans,
                manualTotal: gameState.manualTotal,
                lastTime: Date.now(),
                playerName: gameState.playerName,
                playerId: gameState.playerId
            },
            items: items.map(item => ({ name: item.name, owned: item.owned }))
        };
        localStorage.setItem('careerBrewSaveV16', JSON.stringify(saveData));
        
        // [ì¤‘ìš”] Firebaseì—ë„ ì €ì¥
        saveScoreToFirebase();

        if (showToast) {
            const toast = document.getElementById('toast');
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 1500);
        }
    }

    window.loadGame = function() {
        const savedString = localStorage.getItem('careerBrewSaveV16');
        
        // V13 -> V16 ë§ˆì´ê·¸ë ˆì´ì…˜
        if (!savedString && localStorage.getItem('careerBrewSaveV13')) {
             localStorage.setItem('careerBrewSaveV16', localStorage.getItem('careerBrewSaveV13'));
        }

        if (savedString) {
            try {
                const savedData = JSON.parse(savedString);
                if (savedData.gameState) {
                    gameState.beans = savedData.gameState.beans || 0;
                    gameState.manualTotal = savedData.gameState.manualTotal || 0;
                    gameState.playerName = savedData.gameState.playerName || "ìµëª…";
                    gameState.playerId = savedData.gameState.playerId || generateUUID();
                }
                if (savedData.items) {
                    savedData.items.forEach(savedItem => {
                        const item = items.find(i => i.name === savedItem.name);
                        if (item) item.owned = savedItem.owned;
                    });
                }
                window.recalculateStats();
                // ... (ì˜¤í”„ë¼ì¸ ìˆ˜ìµ ë¡œì§ ìƒëµ)
            } catch (e) { console.error(e); }
        } else {
            // ì²˜ìŒ í•˜ëŠ” ì‚¬ëŒ: ID ìƒì„± ë° ë‹‰ë„¤ì„ ë¬»ê¸°
            gameState.playerId = generateUUID();
            let inputName = prompt("ë­í‚¹ì— ë“±ë¡í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!", "ë°”ë¦¬ìŠ¤íƒ€");
            if(inputName) gameState.playerName = inputName;
        }
        document.getElementById('player-name').textContent = gameState.playerName;
    }
    
    function generateUUID() {
        return 'user-' + Math.random().toString(36).substr(2, 9);
    }

    window.recalculateStats = function() {
        gameState.baseBps = 0;
        gameState.baseClick = 1;
        items.forEach(item => {
            if (item.type === 'click') gameState.baseClick += item.val * item.owned;
            else gameState.baseBps += item.val * item.owned;
        });
    }

    window.resetGame = function() {
        if (confirm("âš ï¸ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('careerBrewSaveV16');
            location.reload();
        }
    }

    // [ë­í‚¹] Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì „êµ­ ë­í‚¹)
    async function fetchRealRanking() {
        const listDiv = document.getElementById('rank-list-national');
        listDiv.innerHTML = "ğŸ“¡ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        
        try {
            const q = window.query(
                window.collection(window.db, "leaderboard"),
                window.orderBy("score", "desc"),
                window.limit(50)
            );
            const querySnapshot = await window.getDocs(q);
            
            let html = '';
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const isMe = (doc.id === gameState.playerId);
                const isMeClass = isMe ? 'my-rank' : '';
                const rankClass = rank <= 3 ? 'top-3' : '';
                const badge = rank <= 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1] : rank;

                html += `
                    <div class="rank-item ${isMeClass}">
                        <div>
                            <span class="rank-badge ${rankClass}">${badge}</span>
                            <span style="font-weight:${isMe?'900':'normal'}">${data.name}</span>
                        </div>
                        <div style="font-family:monospace; font-weight:bold; color:#555;">
                            ${formatNum(data.score)} BPS
                        </div>
                    </div>
                `;
                rank++;
            });
            
            if(html === '') html = '<div style="padding:20px;">ì•„ì§ ë“±ë¡ëœ ë­ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</div>';
            listDiv.innerHTML = html;

        } catch(e) {
            console.error("ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", e);
            listDiv.innerHTML = "âŒ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>(Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)";
        }
    }

    // ê°€ìƒ ë­í‚¹ (ì§€ì—­/ì¹œêµ¬ìš©) - ê¸°ì¡´ ì½”ë“œ ìœ ì§€
    function renderVirtualRanking(type) {
        const npcNames = {
            regional: ["ê°•ë‚¨êµ¬ ê±´ë¬¼ì£¼", "íŒêµ ì•¼ê·¼ëŸ¬", "ì—­ì‚¼ë™ ì¹´ëˆ„ ì¥ì¸", "ì„±ìˆ˜ë™ í™ìŠ¤í„°", "ì˜†ì§‘ ìŠ¤íƒ€ë²…ìŠ¤", "ì•ì§‘ ì´ë””ì•¼", "ìœ—ì§‘ ì¸µê°„ì†ŒìŒë²”", "ë™ë„¤ ë°±ìˆ˜ í˜•", "í¸ì˜ì  ì•Œë°”ì™•", "í•œê°• ë¼ë©´ ë§¤ë‹ˆì•„"],
            friend: ["ê¹€ì½”ë”©", "ì´ìë°”", "ë°•íŒŒì´ì¬", "ìµœì„œë²„", "ì •í´ë¼", "í•œë””ì", "ì˜¤ê¸°íš", "ìœ ëŒ€í‘œ", "ì¡°ì¸í„´", "í™©ë¶€ì¥"]
        };
        const listDiv = document.getElementById(`rank-list-${type}`);
        const currentScore = gameState.baseBps * (gameState.isFever ? 10 : 1);
        let rankData = [];
        
        npcNames[type].forEach((name) => {
            let multiplier = (type === 'regional') ? Math.pow(10, (Math.random() * 4) - 2) : Math.random() * 2 + 0.1;
            let score = currentScore * multiplier;
            if (score < 10) score = Math.random() * 100;
            rankData.push({ name: name, score: score, isMe: false });
        });
        rankData.push({ name: `${gameState.playerName} (ë‚˜)`, score: currentScore, isMe: true });
        rankData.sort((a, b) => b.score - a.score);

        let html = '';
        rankData.forEach((p, index) => {
            const rank = index + 1;
            const isMeClass = p.isMe ? 'my-rank' : '';
            const rankClass = rank <= 3 ? 'top-3' : '';
            const badge = rank <= 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1] : rank;
            html += `<div class="rank-item ${isMeClass}"><div><span class="rank-badge ${rankClass}">${badge}</span><span style="font-weight:${p.isMe?'900':'normal'}">${p.name}</span></div><div style="font-family:monospace; font-weight:bold; color:#555;">${formatNum(p.score)} BPS</div></div>`;
        });
        listDiv.innerHTML = html;
    }

    window.switchRankTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.rank-list-container').forEach(div => div.style.display = 'none');
        document.getElementById(`rank-list-${tabName}`).style.display = 'block';

        if(tabName === 'national') fetchRealRanking(); // ì§„ì§œ ì„œë²„
        else renderVirtualRanking(tabName); // ê°€ìƒ
    }

    window.showRanking = function() {
        document.getElementById('ranking-modal').style.display = 'flex';
        // ê¸°ë³¸ìœ¼ë¡œ ì „êµ­ ë­í‚¹(ì„œë²„) ë¡œë“œ
        window.switchRankTab('national');
        // íƒ­ ë²„íŠ¼ UI ì´ˆê¸°í™”
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.tab-btn:first-child').classList.add('active');
    }

    window.closeRanking = function() { document.getElementById('ranking-modal').style.display = 'none'; }

    // --- Draw ë° Loop ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (gameState.clickScale < 1.0) {
            gameState.clickScale += 0.03;
            if (gameState.clickScale > 1.0) gameState.clickScale = 1.0;
        }

        if (gameState.baseBps > 1e8 || gameState.baseClick > 1e8) {
            ctx.fillStyle = '#0d1b2a'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = '#fff'; for(let i=0; i<20; i++) { ctx.globalAlpha = Math.random(); ctx.fillRect(Math.random()*400, Math.random()*180, 2, 2); } ctx.globalAlpha = 1.0;
        } else {
            ctx.fillStyle = gameState.isFever ? '#fff9c4' : '#faf3e0'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        ctx.save();
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2 + 15;
        ctx.translate(centerX, centerY);
        if (gameState.isFever) { const shake = Math.sin(Date.now() / 50) * 5; ctx.rotate(shake * Math.PI / 180); ctx.scale(1.1, 1.1); }
        ctx.scale(gameState.clickScale, gameState.clickScale);
        if (beanImg.complete) {
            const size = 130; ctx.shadowColor = "rgba(62, 39, 35, 0.4)"; ctx.shadowBlur = 15; ctx.shadowOffsetY = 10;
            ctx.drawImage(beanImg, -size/2, -size/2, size, size);
        } else {
            ctx.fillStyle = gameState.isFever ? '#ff5722' : '#6d4c41'; ctx.beginPath(); ctx.arc(0, 0, 50, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();

        particles.forEach((p, i) => {
            ctx.fillStyle = (gameState.baseBps > 1e8) ? `rgba(255, 255, 255, ${p.life})` : `rgba(62, 39, 35, ${p.life})`;
            ctx.beginPath(); ctx.arc(p.x, p.y, 7, 0, Math.PI*2); ctx.fill();
            p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.03;
            if (p.life <= 0) particles.splice(i, 1);
        });

        ctx.textAlign = 'center';
        floatingTexts.forEach((ft, i) => {
            ctx.save(); ctx.globalAlpha = ft.life;
            ctx.font = (gameState.isFever ? '900 24px' : '800 18px') + ' Arial';
            ctx.fillStyle = gameState.isFever ? '#d50000' : '#fff';
            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 4;
            ctx.fillText(`+${formatNum(ft.val)}`, ft.x, ft.y); ctx.restore();
            ft.y -= 1; ft.life -= 0.02; if (ft.life <= 0) floatingTexts.splice(i, 1);
        });

        ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(50, 155, 300, 10);
        ctx.fillStyle = gameState.isFever ? '#d50000' : '#fb8c00'; ctx.fillRect(50, 155, 300 * (gameState.feverGauge/100), 10);
        
        ctx.fillStyle = (gameState.baseBps > 1e8) ? '#fff' : '#8d6e63'; 
        ctx.font = '900 16px Arial'; ctx.textAlign = 'center';
        ctx.fillText(gameState.isFever ? "ğŸ”¥ FEVER MODE (x10) ğŸ”¥" : "CLICK TO ROAST", 200, 105); ctx.textAlign = 'start';
    }

    function handleInput(e) {
        e.preventDefault(); 
        const rect = canvas.getBoundingClientRect();
        const points = e.changedTouches ? e.changedTouches : [{clientX: e.clientX, clientY: e.clientY}];
        for (let i = 0; i < points.length; i++) {
            const p = points[i];
            const x = (p.clientX - rect.left) * (canvas.width / rect.width);
            const y = (p.clientY - rect.top) * (canvas.height / rect.height);
            if (x > 0 && x < 400 && y > 0 && y < 180) {
                gameState.clickScale = 0.9;
                const multiplier = gameState.isFever ? 10 : 1;
                const clickGain = gameState.baseClick * multiplier;
                gameState.beans += clickGain; gameState.manualTotal += clickGain;
                floatingTexts.push({ x: x, y: y, val: clickGain, life: 1.0 });
                if (!gameState.isFever) {
                    gameState.feverGauge = Math.min(100, gameState.feverGauge + 2);
                    if (gameState.feverGauge >= 100) startFever();
                }
                for(let j=0; j<6; j++) { particles.push({x: x, y: y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, life:1}); }
            }
        }
    }
    canvas.addEventListener('touchstart', handleInput, {passive: false});
    canvas.addEventListener('mousedown', handleInput);

    function startFever() {
        gameState.isFever = true;
        const fInter = setInterval(() => {
            gameState.feverGauge -= 1.0;
            if (gameState.feverGauge <= 0) { gameState.isFever = false; gameState.feverGauge = 0; clearInterval(fInter); }
        }, 50);
    }

    function updateStore() {
        const upgradesDiv = document.getElementById('upgrades');
        upgradesDiv.innerHTML = '';
        items.forEach((item, index) => {
            const price = Math.floor(item.basePrice * Math.pow(1.15, item.owned));
            let isLocked = false;
            if (index > 0 && items[index-1].owned === 0) isLocked = true;

            const btn = document.createElement('button');
            const isClickItem = item.type === 'click';
            let btnClass = isClickItem ? 'btn-click' : 'btn-bps';
            if (isLocked) btnClass = 'btn-locked';

            btn.className = btnClass;
            btn.disabled = isLocked || (gameState.beans < price);
            if (isLocked) btn.classList.add('locked');

            const effectColor = isClickItem ? '#e65100' : '#00695c';
            const typeIcon = isClickItem ? 'ğŸ‘†' : 'âš™ï¸';
            const unitText = isClickItem ? '/í´ë¦­' : '/ì´ˆ';
            let displayName = `${typeIcon} ${item.name}`;
            let displayCost = `ë¹„ìš©: ${formatNum(price)} ğŸ«˜`;
            let displayOwned = `Lv. ${item.owned}`;
            let displayEffect = `+${formatNum(item.val)}${unitText}`;
            let displayEffectStyle = `color:${effectColor}`;
            if (isLocked) { displayEffect = "???"; displayEffectStyle = "color:#999"; }

            btn.innerHTML = `<div class="item-info"><span class="item-name">${displayName}</span><div class="item-lvl" style="margin-top:4px; text-align:left;">${displayOwned}</div></div><div class="item-right"><span class="item-cost" style="margin-bottom:4px;">${displayCost}</span><div class="item-effect" style="${displayEffectStyle}">${displayEffect}</div></div>`;
            btn.onclick = (e) => {
                if (isLocked) return;
                if (gameState.beans >= price) {
                    gameState.beans -= price; item.owned++;
                    if (item.type === 'click') gameState.baseClick += item.val;
                    else gameState.baseBps += item.val;
                    updateStore(); 
                    window.saveGame();
                }
            };
            upgradesDiv.appendChild(btn);
        });
    }

    setInterval(() => { if (!gameState.isFever && gameState.feverGauge > 0) gameState.feverGauge = Math.max(0, gameState.feverGauge - 0.5); }, 100);

    function gameLoop() {
        const now = Date.now();
        const delta = (now - gameState.lastTime) / 1000;
        gameState.lastTime = now;
        const multiplier = gameState.isFever ? 10 : 1;
        const currentBps = gameState.baseBps * multiplier;
        const currentClick = gameState.baseClick * multiplier;
        gameState.beans += currentBps * delta;
        
        document.getElementById('beans').textContent = formatNum(gameState.beans);
        const bpsBadge = document.getElementById('bps');
        const clickBadge = document.getElementById('click-power');
        bpsBadge.textContent = formatNum(currentBps);
        clickBadge.textContent = formatNum(currentClick);

        if(gameState.isFever) {
            const shake = `scale(${1 + Math.sin(now/50)*0.1})`;
            bpsBadge.parentElement.style.color = '#d50000'; bpsBadge.style.transform = shake; clickBadge.style.transform = shake;
        } else {
            bpsBadge.parentElement.style.color = '#5d4037'; bpsBadge.style.transform = 'scale(1)'; clickBadge.style.transform = 'scale(1)';
        }

        document.getElementById('manualTotal').textContent = formatNum(gameState.manualTotal);
        const score = Math.max(gameState.baseBps, gameState.baseClick);
        if (score > 0) {
            const levelIndex = Math.min(Math.floor(Math.log10(score)), gameState.levels.length - 1);
            if (levelIndex >= 0) document.getElementById('level').textContent = gameState.levels[levelIndex];
        }

        const buttons = document.querySelectorAll('#upgrades button');
        items.forEach((item, i) => {
            const price = Math.floor(item.basePrice * Math.pow(1.15, item.owned));
            let isLocked = false;
            if (i > 0 && items[i-1].owned === 0) isLocked = true;
            if (buttons[i]) buttons[i].disabled = isLocked || (gameState.beans < price);
        });

        draw();
        requestAnimationFrame(gameLoop);
    }

    window.loadGame();
    updateStore();
    gameLoop();

    setInterval(() => { window.saveGame(); }, 30000); // 30ì´ˆë§ˆë‹¤ ìë™ ì €ì¥
    window.addEventListener('beforeunload', () => { window.saveGame(); });

</script>
</body>
</html>
