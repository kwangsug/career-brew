<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì»¤ë¦¬ì–´ ë¸Œë£¨: ì§€ê·¸ì¬ê·¸ (ì˜¨ë¼ì¸)</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • (ë°°ê²½ìƒ‰ì€ JSë¡œ ì œì–´í•˜ê¸° ìœ„í•´ body ë°°ê²½ ì œê±°) */
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; text-align: center; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; box-sizing: border-box; touch-action: manipulation; height: 100vh; display: flex; align-items: center; justify-content: center; transition: background 1s, color 1s; }
        * { box-sizing: border-box; }
        
        #game-container { width: 100%; max-width: 450px; height: 100%; max-height: 100vh; padding: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; transition: background 1s; }
        
        h1 { margin: 5px 0 10px 0; font-size: 20px; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 1s; }
        
        /* ìº”ë²„ìŠ¤ ë°°ê²½ íˆ¬ëª…í•˜ê²Œ (ìƒìœ„ ë°°ê²½ ë”°ë¼ê°€ë„ë¡) */
        canvas { border-radius: 12px; background: rgba(255,255,255,0.2); cursor: pointer; width: 100%; touch-action: none; display: block; margin-bottom: 5px; -webkit-tap-highlight-color: transparent; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); backdrop-filter: blur(5px); }
        
        #ui { margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 15px; border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(10px); }
        .level-line { font-weight: bold; font-size: 15px; margin-bottom: 5px; border-bottom: 1px dashed rgba(0,0,0,0.2); padding-bottom: 5px; width: 100%; }
        
        #mini-ranking { font-size: 15px; color: #1565c0; font-weight: 900; background: rgba(227, 242, 253, 0.9); padding: 8px 20px; border-radius: 20px; margin-bottom: 5px; animation: fadeIn 0.5s; border: 2px solid #90caf9; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        #msg-bar { font-size: 13px; font-weight: bold; margin-top: 8px; height: 18px; transition: opacity 0.5s; opacity: 1; text-shadow: 1px 1px 0 rgba(255,255,255,0.5); width: 100%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .fade-out { opacity: 0 !important; }

        .main-beans { font-size: 38px; margin: 0 0 5px 0; font-weight: 900; word-break: keep-all; letter-spacing: -1px; line-height: 1.0; text-shadow: 2px 2px 0 rgba(255,255,255,0.5); }
        
        .stats-container { display: flex; justify-content: center; gap: 15px; width: 100%; margin-top: 5px; border-top: 1px dashed rgba(0,0,0,0.2); padding-top: 8px;}
        .stat-row { display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; font-size: 13px; }
        
        .badge { padding: 3px 10px; border-radius: 20px; min-width: 60px; display: inline-block; text-align: center; border: 2px solid transparent; font-weight: 800; font-size: 13px; margin-top: 2px;}
        .badge-click { background: #ffe0b2; color: #e65100; border-color: #ffb74d; }
        .badge-bps { background: #e0f2f1; color: #00695c; border-color: #4db6ac; }
        
        .store-header { text-align: left; margin: 5px 0 8px 0; font-size: 16px; font-weight: 800; border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #upgrades { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 10px; min-height: 150px; }
        #upgrades::-webkit-scrollbar { width: 4px; }
        #upgrades::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        
        button { background: rgba(255,255,255,0.9); border: 2px solid rgba(0,0,0,0.1); padding: 10px 12px 10px 15px; cursor: pointer; border-radius: 10px; display: flex; justify-content: space-between; transition: 0.1s; align-items: center; text-align: left; position: relative; overflow: visible; min-height: 70px; height: auto; box-shadow: 0 2px 0 rgba(0,0,0,0.1); width: 100%; flex-shrink: 0; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 0 0; }
        button:disabled { background: rgba(240,240,240,0.8); color: #aaa; cursor: not-allowed; opacity: 1; border-color: transparent; box-shadow: none; }
        button.locked { background: rgba(230,230,230,0.8); border-color: transparent; opacity: 0.7; }
        .btn-click { border-left: 6px solid #ff9800; }
        .btn-bps { border-left: 6px solid #009688; }
        .btn-locked { border-left: 6px solid #bdbdbd; }
        
        .item-info { display: flex; flex-direction: column; gap: 3px; z-index: 2; flex: 1; }
        .item-name { font-weight: 900; font-size: 15px; color: #333; letter-spacing: -0.5px; line-height: 1.2; }
        .item-cost { font-size: 12px; color: #5d4037; font-weight: 700; background: rgba(139, 69, 19, 0.08); padding: 2px 5px; border-radius: 4px; display: inline-block; width: fit-content; }
        .item-right { text-align: right; min-width: 90px; display: flex; flex-direction: column; align-items: flex-end;}
        .item-effect { font-weight: 900; font-size: 13px; z-index: 2; text-shadow: 1px 1px 0 #fff; line-height: 1.2; word-break: break-all;}
        .item-lvl { font-size: 11px; color: #888; font-weight: bold; }
        
        .rank-info { font-size: 12px; margin-top: 5px; cursor: pointer; font-weight: bold; flex-shrink: 0; text-align: center; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 8px;}
        #toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 3000;}
        .footer-controls { margin-top: 8px; display: flex; justify-content: center; gap: 15px; align-items: center; flex-shrink: 0; padding-bottom: 5px;}
        .save-btn { background: #8d6e63; color: white; border: none; padding: 6px 12px; font-size: 12px; border-radius: 20px; box-shadow: none; min-height: 0; width: auto; display: inline-block;}
        .reset-btn { background: none; border: none; padding: 5px; font-size: 11px; color: inherit; text-decoration: underline; cursor: pointer; min-height: 0; width: auto; box-shadow: none; display: inline-block; opacity: 0.7;}
        
        #ranking-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; width:90%; max-width:380px; padding:25px; border-radius:20px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .tab-container { display: flex; justify-content: space-around; margin-bottom: 15px; border-bottom: 2px solid #eee; }
        .tab-btn { background: none; border: none; padding: 10px; font-weight: bold; color: #888; cursor: pointer; flex: 1; border-bottom: 3px solid transparent; box-shadow: none; min-height: 40px; border-radius: 0; }
        .tab-btn.active { color: #3e2723; border-bottom-color: #3e2723; }
        .rank-list-container { max-height: 300px; overflow-y: auto; text-align: left; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f5f5f5; font-size: 14px; color:#333; }
        .rank-item.my-rank { background: #fff3e0; border-radius: 8px; font-weight: bold; color: #d84315; border: 1px solid #ffe0b2; }
        .rank-badge { width: 24px; display: inline-block; text-align: center; font-weight: bold; color: #8d6e63; margin-right: 5px; }
        .top-3 { color: #fbc02d; text-shadow: 1px 1px 0 #fff9c4; font-size: 16px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
<div id="game-container">
    <div id="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
    <h1 id="game-title">â˜• ì»¤ë¦¬ì–´ ë¸Œë£¨: ì§€ê·¸ì¬ê·¸</h1>
    
    <div id="ui">
        <div class="level-line">
            <span id="player-name" style="font-size:14px; margin-right:5px; opacity:0.8;"></span>
            ì§ê¸‰: <span id="level" style="color:#d2691e; font-size:18px;">ì•Œë°”ìƒ</span>
        </div>

        <div id="mini-ranking">ğŸ† ìˆœìœ„ ê³„ì‚°ì¤‘...</div>

        <div class="main-beans"><span id="beans">0</span> ğŸ«˜</div>
        <div style="font-size: 12px; font-weight: bold; margin-bottom:5px; opacity:0.7;">ì†ìœ¼ë¡œ ë³¶ì€ ì½©: <span id="manualTotal">0</span></div>

        <div class="stats-container">
            <div class="stat-row">
                <span>ğŸ‘† í´ë¦­ë‹¹</span>
                <span id="click-power" class="badge badge-click">1</span>
            </div>
            <div class="stat-row">
                <span>âš™ï¸ ì´ˆë‹¹</span>
                <span id="bps" class="badge badge-bps">0</span>
            </div>
        </div>

        <div id="msg-bar">ì˜¤ëŠ˜ë„ í™”ì´íŒ…!</div>
    </div>

    <canvas id="game" width="400" height="180"></canvas>
    
    <div class="store-header">
        <span>ğŸ›’ ìƒì </span>
        <span style="font-size:12px; font-weight:bold; opacity:0.8;">ì„±ì¥í•˜ì„¸ìš”!</span>
    </div>
    <div id="upgrades"></div>
    
    <div class="rank-info" onclick="window.showRanking()">ğŸ† <b>ì „ì²´ ë­í‚¹ ë³´ê¸°</b> (í´ë¦­)</div>
    
    <div class="footer-controls">
        <button class="save-btn" onclick="window.saveGame(true)">ğŸ’¾ ì €ì¥ & ë­í‚¹ë“±ë¡</button>
        <button class="reset-btn" onclick="window.resetGame()">ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="ranking-modal">
    <div class="modal-content">
        <h2 style="color:#3e2723; margin-top:0; margin-bottom:10px;">ğŸ† ì‹¤ì‹œê°„ ë­í‚¹</h2>
        <div class="tab-container">
            <button class="tab-btn active" onclick="window.switchRankTab('national')">ğŸŒ ì „êµ­ (ì‹¤ì‹œê°„)</button>
            <button class="tab-btn" onclick="window.switchRankTab('regional')">ğŸ˜ï¸ ì§€ì—­ (ê°€ìƒ)</button>
            <button class="tab-btn" onclick="window.switchRankTab('friend')">ğŸ‘¥ ì¹œêµ¬ (ê°€ìƒ)</button>
        </div>
        <div id="rank-list-national" class="rank-list-container">ë¡œë”©ì¤‘...</div>
        <div id="rank-list-regional" class="rank-list-container" style="display:none;"></div>
        <div id="rank-list-friend" class="rank-list-container" style="display:none;"></div>
        <button onclick="window.closeRanking()" style="width:100%; margin-top:15px; height:45px; font-size:16px; font-weight:bold; background:#3e2723; color:white; border:none; border-radius:10px; cursor:pointer;">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const beanImg = new Image();
    beanImg.src = "https://cdn-icons-png.flaticon.com/512/751/751663.png";

    window.gameState = {
        beans: 0, baseBps: 0, baseClick: 1, manualTotal: 0,
        feverGauge: 0, isFever: false, lastTime: Date.now(), clickScale: 1.0,
        playerName: "ìµëª…", playerId: "",
        levels: ['ì•Œë°”ìƒ', 'ì£¼ì„', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬', 'CEO', 'ì»¤í”¼ ì¬ë²Œ', 'ì›ë‘ ì¥ê´€', 'ì§€êµ¬ ëŒ€í†µë ¹', 'íƒœì–‘ê³„ ê´€ë¦¬ì', 'ì€í•˜ê³„ ì§€ë°°ì', 'ìš°ì£¼ì˜ ì£¼ì¸', 'ì»¤í”¼ì˜ ì‹ '],
        
        // [ì‹ ê·œ] í™©ê¸ˆ ì›ë‘ ìƒíƒœ
        goldenBean: { active: false, x: 0, y: 0, life: 0, timer: 0 }
    };

    window.items = [
        { name: 'â˜• ëª¨ì¹´í¬íŠ¸', type: 'bps', basePrice: 50, val: 1, owned: 0 }, 
        { name: 'ğŸ§¤ ê³ ë¬´ ì¥ê°‘', type: 'click', basePrice: 100, val: 2, owned: 0 }, 
        { name: 'ğŸ”Œ ê°€ì •ìš© ë¨¸ì‹ ', type: 'bps', basePrice: 2000, val: 20, owned: 0 }, 
        { name: 'ğŸ”¨ ì›ë‘ ë§ì¹˜', type: 'click', basePrice: 4000, val: 40, owned: 0 }, 
        { name: 'ğŸª í”„ëœì°¨ì´ì¦ˆ', type: 'bps', basePrice: 50000, val: 500, owned: 0 }, 
        { name: 'ğŸ“ ë°”ë¦¬ìŠ¤íƒ€ 1ê¸‰', type: 'click', basePrice: 100000, val: 1000, owned: 0 }, 
        { name: 'ğŸ­ ìŠ¤ë§ˆíŠ¸ íŒ©í† ë¦¬', type: 'bps', basePrice: 1500000, val: 15000, owned: 0 },
        { name: 'âš¡ ì „ê¸° ì¥ê°‘', type: 'click', basePrice: 3000000, val: 30000, owned: 0 }, 
        { name: 'ğŸš¢ ì›ë‘ ë¬´ì—­ì„ ', type: 'bps', basePrice: 50000000, val: 500000, owned: 0 }, 
        { name: 'ğŸ¦¾ ì‚¬ì´ë³´ê·¸ íŒ”', type: 'click', basePrice: 100000000, val: 1000000, owned: 0 }, 
        { name: 'ğŸ™ï¸ ì»¤í”¼ ì œêµ­ ë³¸ì‚¬', type: 'bps', basePrice: 2000000000, val: 20000000, owned: 0 }, 
        { name: 'ğŸ§¬ ëŒì—°ë³€ì´ ì†', type: 'click', basePrice: 4000000000, val: 40000000, owned: 0 }, 
        { name: 'ğŸ¤– AI êµ°ë‹¨', type: 'bps', basePrice: 80000000000, val: 800000000, owned: 0 }, 
        { name: 'ğŸ§  ë‡ŒíŒŒ ë¡œìŠ¤íŒ…', type: 'click', basePrice: 160000000000, val: 1600000000, owned: 0 }, 
        { name: 'ğŸŒ§ï¸ ì¸ê³µê°•ìš° ìœ„ì„±', type: 'bps', basePrice: 3000000000000, val: 30000000000, owned: 0 }, 
        { name: 'ğŸŒ‹ ë§ˆê·¸ë§ˆ í„°ì¹˜', type: 'click', basePrice: 6000000000000, val: 60000000000, owned: 0 }, 
        { name: 'ğŸŒ• ë‹¬í‘œë©´ ê±´ì¡°ì¥', type: 'bps', basePrice: 150000000000000, val: 1000000000000, owned: 0 }, 
        { name: 'â˜„ï¸ ìœ ì„±ìš° íƒ€ê²©', type: 'click', basePrice: 300000000000000, val: 2000000000000, owned: 0 }, 
        { name: 'â˜¢ï¸ í•µìœµí•© ë³´ì¼ëŸ¬', type: 'bps', basePrice: 8000000000000000, val: 50000000000000, owned: 0 },
        { name: 'â˜€ï¸ íƒœì–‘ê¶Œ í€ì¹˜', type: 'click', basePrice: 16000000000000000, val: 100000000000000, owned: 0 },
        { name: 'ğŸ•³ï¸ ë¸”ë™í™€ ë¶„ì‡„ê¸°', type: 'bps', basePrice: 500000000000000000, val: 3000000000000000, owned: 0 }, 
        { name: 'ğŸŒ€ ì›Œí”„ í´ë¦­', type: 'click', basePrice: 1000000000000000000, val: 6000000000000000, owned: 0 }, 
        { name: 'ğŸ’¥ ë¹…ë±… ë¡œìŠ¤í„°', type: 'bps', basePrice: 20000000000000000000, val: 100000000000000000, owned: 0 }, 
        { name: 'âœ¨ í˜„ì‹¤ ì¡°ì‘', type: 'click', basePrice: 50000000000000000000, val: 250000000000000000, owned: 0 },
        { name: 'â³ ì‹œê°„ì˜ ì§€ë°°ì', type: 'bps', basePrice: 150000000000000000000, val: 800000000000000000, owned: 0 }, 
        { name: 'ğŸ‘‘ ì»¤í”¼ì˜ ì‹ ', type: 'click', basePrice: 450000000000000000000, val: 2000000000000000000, owned: 0 } 
    ];

    window.formatNum = function(num) {
        num = Math.floor(num); 
        if (num < 10000) return num.toLocaleString();
        const units = ["", "ë§Œ", "ì–µ", "ì¡°", "ê²½", "í•´", "ì", "ì–‘", "êµ¬", "ê°„", "ì •", "ì¬", "ê·¹"];
        let unitIndex = Math.floor(Math.log10(num) / 4);
        if (unitIndex >= units.length) unitIndex = units.length - 1;
        const majorUnitVal = Math.pow(10000, unitIndex);
        const majorNum = Math.floor(num / majorUnitVal);
        const minorNum = Math.floor((num % majorUnitVal) / (majorUnitVal / 10000));
        let result = `${majorNum}${units[unitIndex]}`;
        if (minorNum > 0 && unitIndex > 0) result += ` ${minorNum}${units[unitIndex - 1]}`;
        return result;
    }

    let particles = [];
    let floatingTexts = [];

    window.saveGame = function(showToast = false) {
        const saveData = {
            gameState: {
                beans: window.gameState.beans,
                manualTotal: window.gameState.manualTotal,
                lastTime: Date.now(),
                playerName: window.gameState.playerName,
                playerId: window.gameState.playerId
            },
            items: window.items.map(item => ({ name: item.name, owned: item.owned }))
        };
        localStorage.setItem('careerBrewSaveV17', JSON.stringify(saveData));
        if (window.firebaseSave) window.firebaseSave();
        if (showToast) {
            const toast = document.getElementById('toast');
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 1500);
        }
    }

    function generateUUID() { return 'user-' + Math.random().toString(36).substr(2, 9); }

    window.loadGame = function() {
        const savedString = localStorage.getItem('careerBrewSaveV17');
        if (!savedString && localStorage.getItem('careerBrewSaveV16')) {
             localStorage.setItem('careerBrewSaveV17', localStorage.getItem('careerBrewSaveV16'));
        }
        if (savedString) {
            try {
                const savedData = JSON.parse(savedString);
                if (savedData.gameState) {
                    window.gameState.beans = savedData.gameState.beans || 0;
                    window.gameState.manualTotal = savedData.gameState.manualTotal || 0;
                    window.gameState.playerName = savedData.gameState.playerName || "ìµëª…";
                    window.gameState.playerId = savedData.gameState.playerId || generateUUID();
                }
                if (savedData.items) {
                    savedData.items.forEach(savedItem => {
                        const item = window.items.find(i => i.name === savedItem.name);
                        if (item) item.owned = savedItem.owned;
                    });
                }
                recalculateStats();
            } catch (e) { console.error(e); }
        } else {
            const adjectives = ["ì¡¸ë¦°", "í–‰ë³µí•œ", "ë°°ê³ í”ˆ", "ì•¼ê·¼í•˜ëŠ”", "ì¹´í˜ì¸", "ì—´ì •ì ì¸", "ëˆ ë§ì€", "ê°€ë‚œí•œ", "ì „ì„¤ì˜", "ì´ˆë³´"];
            const nouns = ["ë°”ë¦¬ìŠ¤íƒ€", "ê°œë°œì", "ì‚¬ì¥ë‹˜", "ì•Œë°”ìƒ", "ê±´ë¬¼ì£¼", "ì»¤í”¼ì¤‘ë…ì", "ë¡œìŠ¤í„°", "ì›ë‘ê°ë³„ì‚¬"];
            const randomName = adjectives[Math.floor(Math.random() * adjectives.length)] + " " + nouns[Math.floor(Math.random() * nouns.length)];

            window.gameState.playerId = generateUUID();
            let inputName = prompt("ë­í‚¹ì— ë“±ë¡í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!", randomName);
            if(inputName) window.gameState.playerName = inputName;
            else window.gameState.playerName = randomName;
        }
        document.getElementById('player-name').textContent = window.gameState.playerName;
        const titleText = `â˜• ${window.gameState.playerName}ì˜ ì»¤ë¦¬ì–´ ë¸Œë£¨: ì§€ê·¸ì¬ê·¸`;
        document.title = titleText;
        document.getElementById('game-title').innerText = titleText;
    }

    function recalculateStats() {
        window.gameState.baseBps = 0;
        window.gameState.baseClick = 1;
        window.items.forEach(item => {
            if (item.type === 'click') window.gameState.baseClick += item.val * item.owned;
            else window.gameState.baseBps += item.val * item.owned;
        });
    }

    window.resetGame = function() {
        if (confirm("âš ï¸ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('careerBrewSaveV17');
            location.reload();
        }
    }

    // [ì‹ ê·œ] ë°°ê²½ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì§ê¸‰ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½)
    function updateBackground(levelIndex) {
        const body = document.body;
        const container = document.getElementById('game-container');
        const h1 = document.querySelector('h1');
        
        let bgColor = "#fff";
        let textColor = "#333";

        if (levelIndex < 3) { // ì•Œë°”ìƒ ~ ëŒ€ë¦¬
            bgColor = "#fff8e1"; // ë² ì´ì§€
            textColor = "#3e2723";
        } else if (levelIndex < 7) { // ê³¼ì¥ ~ CEO
            bgColor = "#e0f2f1"; // ë¯¼íŠ¸
            textColor = "#004d40";
        } else if (levelIndex < 11) { // ì¬ë²Œ ~ íƒœì–‘ê³„
            bgColor = "#fff3e0"; // ê³¨ë“œ
            textColor = "#bf360c";
        } else { // ìš°ì£¼ ~ ì‹ 
            bgColor = "#1a237e"; // ìš°ì£¼ìƒ‰
            textColor = "#fff";
        }

        body.style.background = bgColor;
        container.style.background = bgColor;
        body.style.color = textColor;
        h1.style.color = textColor;
        document.getElementById('manualTotal').parentElement.style.color = textColor;
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (window.gameState.clickScale < 1.0) {
            window.gameState.clickScale += 0.03;
            if (window.gameState.clickScale > 1.0) window.gameState.clickScale = 1.0;
        }
        
        // ë°°ê²½ ê·¸ë¦¬ê¸° (ìš°ì£¼ ë‹¨ê³„ë©´ ë³„ ì¶”ê°€)
        if (window.gameState.baseBps > 1e16 || window.gameState.baseClick > 1e16) {
            ctx.fillStyle = 'rgba(255,255,255,0.1)'; 
            for(let i=0; i<5; i++) { 
                ctx.beginPath();
                ctx.arc(Math.random()*400, Math.random()*180, Math.random()*2, 0, Math.PI*2);
                ctx.fill();
            }
        }

        ctx.save();
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2 + 15;
        ctx.translate(centerX, centerY);
        if (window.gameState.isFever) { const shake = Math.sin(Date.now() / 50) * 5; ctx.rotate(shake * Math.PI / 180); ctx.scale(1.1, 1.1); }
        ctx.scale(window.gameState.clickScale, window.gameState.clickScale);
        if (beanImg.complete) {
            const size = 130; ctx.shadowColor = "rgba(62, 39, 35, 0.4)"; ctx.shadowBlur = 15; ctx.shadowOffsetY = 10;
            ctx.drawImage(beanImg, -size/2, -size/2, size, size);
        } else {
            ctx.fillStyle = window.gameState.isFever ? '#ff5722' : '#6d4c41'; ctx.beginPath(); ctx.arc(0, 0, 50, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();

        // [ì‹ ê·œ] í™©ê¸ˆ ì›ë‘ ê·¸ë¦¬ê¸°
        if (window.gameState.goldenBean.active) {
            const gb = window.gameState.goldenBean;
            ctx.save();
            ctx.translate(gb.x, gb.y);
            // ë°˜ì§ì´ëŠ” íš¨ê³¼
            const scale = 1 + Math.sin(Date.now() / 100) * 0.1;
            ctx.scale(scale, scale);
            ctx.fillStyle = '#ffd700'; // ê³¨ë“œ
            ctx.shadowColor = '#fff';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.arc(0, 0, 20, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('â˜…', 0, 0);
            ctx.restore();
            
            gb.life -= 0.01;
            if (gb.life <= 0) gb.active = false;
        }

        particles.forEach((p, i) => {
            ctx.fillStyle = (window.gameState.baseBps > 1e8) ? `rgba(255, 255, 255, ${p.life})` : `rgba(62, 39, 35, ${p.life})`;
            ctx.beginPath(); ctx.arc(p.x, p.y, 7, 0, Math.PI*2); ctx.fill();
            p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.03;
            if (p.life <= 0) particles.splice(i, 1);
        });
        ctx.textAlign = 'center';
        floatingTexts.forEach((ft, i) => {
            ctx.save(); ctx.globalAlpha = ft.life;
            ctx.font = (window.gameState.isFever ? '900 24px' : '800 18px') + ' Arial';
            ctx.fillStyle = ft.color || (window.gameState.isFever ? '#d50000' : '#fff');
            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 4;
            ctx.fillText(`+${formatNum(ft.val)}`, ft.x, ft.y); ctx.restore();
            ft.y -= 1; ft.life -= 0.02; if (ft.life <= 0) floatingTexts.splice(i, 1);
        });
        ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(50, 155, 300, 10);
        ctx.fillStyle = window.gameState.isFever ? '#d50000' : '#fb8c00'; ctx.fillRect(50, 155, 300 * (window.gameState.feverGauge/100), 10);
        ctx.fillStyle = (window.gameState.baseBps > 1e16) ? '#fff' : '#8d6e63'; 
        ctx.font = '900 16px Arial'; ctx.textAlign = 'center';
        ctx.fillText(window.gameState.isFever ? "ğŸ”¥ FEVER MODE (x10) ğŸ”¥" : "CLICK TO ROAST", 200, 105); ctx.textAlign = 'start';
    }

    function handleInput(e) {
        e.preventDefault(); 
        const rect = canvas.getBoundingClientRect();
        const points = e.changedTouches ? e.changedTouches : [{clientX: e.clientX, clientY: e.clientY}];
        for (let i = 0; i < points.length; i++) {
            const p = points[i];
            const x = (p.clientX - rect.left) * (canvas.width / rect.width);
            const y = (p.clientY - rect.top) * (canvas.height / rect.height);

            // [ì‹ ê·œ] í™©ê¸ˆ ì›ë‘ í´ë¦­ ì²´í¬
            if (window.gameState.goldenBean.active) {
                const gb = window.gameState.goldenBean;
                const dist = Math.sqrt((x - gb.x)**2 + (y - gb.y)**2);
                if (dist < 40) { // í´ë¦­ ì„±ê³µ
                    window.gameState.goldenBean.active = false;
                    startFever(); // í”¼ë²„ ëª¨ë“œ ë°œë™
                    floatingTexts.push({ x: x, y: y, val: "LUCKY!", life: 2.0, color: "#ffd700" });
                    continue; // ì¼ë°˜ í´ë¦­ì€ íŒ¨ìŠ¤
                }
            }

            if (x > 0 && x < 400 && y > 0 && y < 180) {
                window.gameState.clickScale = 0.9;
                const multiplier = window.gameState.isFever ? 10 : 1;
                const clickGain = window.gameState.baseClick * multiplier;
                window.gameState.beans += clickGain; window.gameState.manualTotal += clickGain;
                floatingTexts.push({ x: x, y: y, val: clickGain, life: 1.0 });
                if (!window.gameState.isFever) {
                    window.gameState.feverGauge = Math.min(100, window.gameState.feverGauge + 2);
                    if (window.gameState.feverGauge >= 100) startFever();
                }
                for(let j=0; j<6; j++) { particles.push({x: x, y: y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, life:1}); }
            }
        }
    }
    canvas.addEventListener('touchstart', handleInput, {passive: false});
    canvas.addEventListener('mousedown', handleInput);

    function startFever() {
        window.gameState.isFever = true;
        window.gameState.feverGauge = 100;
        // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì œê±°í•˜ê³  ìƒˆë¡œ ì‹œì‘ (í™©ê¸ˆì›ë‘ ì¤‘ë³µ ë°©ì§€)
        if (window.feverInterval) clearInterval(window.feverInterval);
        
        window.feverInterval = setInterval(() => {
            window.gameState.feverGauge -= 0.5; // í”¼ë²„ ì§€ì†ì‹œê°„ ì•½ê°„ ì¦ê°€
            if (window.gameState.feverGauge <= 0) { 
                window.gameState.isFever = false; 
                window.gameState.feverGauge = 0; 
                clearInterval(window.feverInterval); 
            }
        }, 50);
    }

    const messageTemplates = [
        "{name}ë‹˜, ì¹´í˜ì¸ ìˆ˜í˜ˆì´ ì‹œê¸‰í•©ë‹ˆë‹¤!",
        "ì ì€ ì£½ì–´ì„œ ìëŠ” ê±°ì£ , {name}ë‹˜?",
        "ì˜†ì§‘ ìŠ¤íƒ€ë²…ìŠ¤ê°€ {name}ë‹˜ì„ ê²¬ì œí•©ë‹ˆë‹¤.",
        "{name}ë‹˜ì˜ ì†ê°€ë½ì€ êµ­ë³´ê¸‰ì…ë‹ˆë‹¤.",
        "ì´ ì†ë„ë©´ í™”ì„± ê°ˆë„ë‹ˆê¹Œ~ ({name}ë‹˜)",
        "{name}ë‹˜, ë­í‚¹ 1ìœ„ê°€ ì½”ì•ì…ë‹ˆë‹¤!",
        "ë²„ê·¸ ì•„ë‹™ë‹ˆë‹¤. {name}ë‹˜ì˜ ì‹¤ë ¥ì…ë‹ˆë‹¤.",
        "ì§€êµ¬ì˜ ëª¨ë“  ì›ë‘ë¥¼ ë³¶ìœ¼ì„¸ìš”, {name}ë‹˜!",
        "{name}ë‹˜, ì˜¤ëŠ˜ ì•¼ê·¼ ê°ì¸ê°€ìš”?",
        "ëˆ ë²„ëŠ” ê¸°ê³„ê°€ ë˜ì…¨êµ°ìš”, {name}ë‹˜.",
        "í´ë¦­! í´ë¦­! ë¶€ì ë˜ì„¸ìš”, {name}ë‹˜!",
        "ê°œë°œìê°€ {name}ë‹˜ì„ ì‘ì›í•©ë‹ˆë‹¤.",
        "{name}ë‹˜, ì»¤í”¼ í•œ ì”ì˜ ì—¬ìœ  ì–´ë•Œìš”?",
        "ë¡œìŠ¤íŒ…ì˜ ì‹ , ê·¸ ì´ë¦„ì€ {name}!",
        "{name}ë‹˜, í‚¤ë³´ë“œ ì‚´ì‚´ ë‹¤ë¤„ì£¼ì„¸ìš”."
    ];
    
    function updateMessage() {
        const el = document.getElementById('msg-bar');
        el.classList.add('fade-out'); 
        setTimeout(() => {
            const template = messageTemplates[Math.floor(Math.random() * messageTemplates.length)];
            el.innerText = template.replace("{name}", window.gameState.playerName);
            el.classList.remove('fade-out');
        }, 500);
    }
    setInterval(updateMessage, 5000); 

    function updateStore() {
        const upgradesDiv = document.getElementById('upgrades');
        upgradesDiv.innerHTML = '';
        window.items.forEach((item, index) => {
            const price = Math.floor(item.basePrice * Math.pow(1.15, item.owned));
            let isLocked = false;
            if (index > 0 && window.items[index-1].owned === 0) isLocked = true;
            const btn = document.createElement('button');
            const isClickItem = item.type === 'click';
            let btnClass = isClickItem ? 'btn-click' : 'btn-bps';
            if (isLocked) btnClass = 'btn-locked';
            btn.className = btnClass;
            btn.disabled = isLocked || (window.gameState.beans < price);
            if (isLocked) btn.classList.add('locked');
            const effectColor = isClickItem ? '#e65100' : '#00695c';
            const typeIcon = isClickItem ? 'ğŸ‘†' : 'âš™ï¸';
            const unitText = isClickItem ? '/í´ë¦­' : '/ì´ˆ';
            let displayName = `${typeIcon} ${item.name}`;
            let displayCost = `ë¹„ìš©: ${formatNum(price)} ğŸ«˜`;
            let displayOwned = `Lv. ${item.owned}`;
            let displayEffect = `+${formatNum(item.val)}${unitText}`;
            let displayEffectStyle = `color:${effectColor}`;
            if (isLocked) { displayEffect = "???"; displayEffectStyle = "color:#999"; }
            btn.innerHTML = `<div class="item-info"><span class="item-name">${displayName}</span><div class="item-lvl" style="margin-top:4px; text-align:left;">${displayOwned}</div></div><div class="item-right"><span class="item-cost" style="margin-bottom:4px;">${displayCost}</span><div class="item-effect" style="${displayEffectStyle}">${displayEffect}</div></div>`;
            btn.onclick = (e) => {
                if (isLocked) return;
                if (window.gameState.beans >= price) {
                    window.gameState.beans -= price; item.owned++;
                    if (item.type === 'click') window.gameState.baseClick += item.val;
                    else window.gameState.baseBps += item.val;
                    updateStore(); window.saveGame();
                }
            };
            upgradesDiv.appendChild(btn);
        });
    }

    setInterval(() => { if (!window.gameState.isFever && window.gameState.feverGauge > 0) window.gameState.feverGauge = Math.max(0, window.gameState.feverGauge - 0.5); }, 100);

    function gameLoop() {
        const now = Date.now();
        const delta = (now - window.gameState.lastTime) / 1000;
        window.gameState.lastTime = now;
        const multiplier = window.gameState.isFever ? 10 : 1;
        const currentBps = window.gameState.baseBps * multiplier;
        const currentClick = window.gameState.baseClick * multiplier;
        window.gameState.beans += currentBps * delta;
        
        document.getElementById('beans').textContent = formatNum(window.gameState.beans);
        const bpsBadge = document.getElementById('bps');
        const clickBadge = document.getElementById('click-power');
        bpsBadge.textContent = formatNum(currentBps);
        clickBadge.textContent = formatNum(currentClick);
        
        if(window.gameState.isFever) {
            const shake = `scale(${1 + Math.sin(now/50)*0.1})`;
            bpsBadge.parentElement.style.color = '#d50000'; bpsBadge.style.transform = shake; clickBadge.style.transform = shake;
        } else {
            bpsBadge.parentElement.style.color = '#5d4037'; bpsBadge.style.transform = 'scale(1)'; clickBadge.style.transform = 'scale(1)';
        }
        
        document.getElementById('manualTotal').textContent = formatNum(window.gameState.manualTotal);
        
        // ë ˆë²¨ ë° ë°°ê²½ ì—…ë°ì´íŠ¸
        const score = Math.max(window.gameState.baseBps, window.gameState.baseClick);
        let levelIndex = 0;
        if (score > 0) {
            levelIndex = Math.min(Math.floor(Math.log10(score)), window.gameState.levels.length - 1);
            if (levelIndex >= 0) document.getElementById('level').textContent = window.gameState.levels[levelIndex];
        }
        updateBackground(levelIndex); // [ì‹ ê·œ] ë°°ê²½ ë³€ê²½

        // [ì‹ ê·œ] í™©ê¸ˆ ì›ë‘ ìƒì„± ë¡œì§ (ì•½ 0.5% í™•ë¥ /í”„ë ˆì„)
        if (!window.gameState.goldenBean.active && Math.random() < 0.005) {
            window.gameState.goldenBean = {
                active: true,
                x: 50 + Math.random() * 300,
                y: 50 + Math.random() * 100,
                life: 3.0 // 3ì´ˆê°„ ì§€ì†
            };
        }

        const buttons = document.querySelectorAll('#upgrades button');
        window.items.forEach((item, i) => {
            const price = Math.floor(item.basePrice * Math.pow(1.15, item.owned));
            let isLocked = false;
            if (i > 0 && window.items[i-1].owned === 0) isLocked = true;
            if (buttons[i]) buttons[i].disabled = isLocked || (window.gameState.beans < price);
        });
        draw();
        requestAnimationFrame(gameLoop);
    }
    
    // ê²Œì„ ì‹œì‘
    window.loadGame();
    updateStore();
    gameLoop();
    setInterval(() => { window.saveGame(); }, 30000);
    window.addEventListener('beforeunload', () => { window.saveGame(); });

    // ê°€ìƒ ë­í‚¹ (fallback)
    window.renderVirtualRanking = function(type) {
        const npcNames = {
            regional: ["ê°•ë‚¨êµ¬ ê±´ë¬¼ì£¼", "íŒêµ ì•¼ê·¼ëŸ¬", "ì—­ì‚¼ë™ ì¹´ëˆ„ ì¥ì¸", "ì„±ìˆ˜ë™ í™ìŠ¤í„°", "ì˜†ì§‘ ìŠ¤íƒ€ë²…ìŠ¤", "ì•ì§‘ ì´ë””ì•¼", "ìœ—ì§‘ ì¸µê°„ì†ŒìŒë²”", "ë™ë„¤ ë°±ìˆ˜ í˜•", "í¸ì˜ì  ì•Œë°”ì™•", "í•œê°• ë¼ë©´ ë§¤ë‹ˆì•„"],
            friend: ["ê¹€ì½”ë”©", "ì´ìë°”", "ë°•íŒŒì´ì¬", "ìµœì„œë²„", "ì •í´ë¼", "í•œë””ì", "ì˜¤ê¸°íš", "ìœ ëŒ€í‘œ", "ì¡°ì¸í„´", "í™©ë¶€ì¥"]
        };
        const listDiv = document.getElementById(`rank-list-${type}`);
        const currentScore = window.gameState.baseBps * (window.gameState.isFever ? 10 : 1);
        let rankData = [];
        npcNames[type].forEach((name) => {
            let multiplier = (type === 'regional') ? Math.pow(10, (Math.random() * 4) - 2) : Math.random() * 2 + 0.1;
            let score = currentScore * multiplier;
            if (score < 10) score = Math.random() * 100;
            rankData.push({ name: name, score: score, isMe: false });
        });
        rankData.push({ name: `${window.gameState.playerName} (ë‚˜)`, score: currentScore, isMe: true });
        rankData.sort((a, b) => b.score - a.score);
        let html = '';
        rankData.forEach((p, index) => {
            const rank = index + 1;
            const isMeClass = p.isMe ? 'my-rank' : '';
            const rankClass = rank <= 3 ? 'top-3' : '';
            const badge = rank <= 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1] : rank;
            html += `<div class="rank-item ${isMeClass}"><div><span class="rank-badge ${rankClass}">${badge}</span><span style="font-weight:${p.isMe?'900':'normal'}">${p.name}</span></div><div style="font-family:monospace; font-weight:bold; color:#555;">${formatNum(p.score)} BPS</div></div>`;
        });
        listDiv.innerHTML = html;
    }

    // íƒ­ ì „í™˜
    window.switchRankTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.rank-list-container').forEach(div => div.style.display = 'none');
        document.getElementById(`rank-list-${tabName}`).style.display = 'block';
        if(tabName === 'national') {
            document.getElementById('rank-list-national').innerHTML = "ğŸ“¡ ì„œë²„ ì—°ê²° ì‹œë„ì¤‘...<br>(ì—°ê²° ì‹¤íŒ¨ì‹œ ê°€ìƒ ë­í‚¹ì´ í‘œì‹œë©ë‹ˆë‹¤)";
            if(window.fetchRealRanking) window.fetchRealRanking();
            else setTimeout(()=> {
                 window.renderVirtualRanking('regional'); 
                 document.getElementById('rank-list-national').innerHTML = "âš ï¸ ì„œë²„ ì—°ê²° ë¶ˆê°€<br>ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.";
            }, 2000);
        }
        else window.renderVirtualRanking(tabName);
    }
    
    window.showRanking = function() {
        document.getElementById('ranking-modal').style.display = 'flex';
        window.switchRankTab('national');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.tab-btn:first-child').classList.add('active');
    }
    window.closeRanking = function() { document.getElementById('ranking-modal').style.display = 'none'; }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, limit, getCountFromServer, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3mv9F87KSAJzuk0VYReg7aQfCQ7ak7ko",
      authDomain: "career-brew.firebaseapp.com",
      projectId: "career-brew",
      storageBucket: "career-brew.firebasestorage.app",
      messagingSenderId: "48722044572",
      appId: "1:48722044572:web:858470248dee6aab42ef59",
      measurementId: "G-5MLYRT46P4"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        console.log("ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ!");

        // 1. ì €ì¥ ê¸°ëŠ¥
        window.firebaseSave = async function() {
            const score = window.gameState.baseBps * (window.gameState.isFever ? 10 : 1);
            try {
                await setDoc(doc(db, "leaderboard", window.gameState.playerId), {
                    name: window.gameState.playerName,
                    score: score,
                    timestamp: Date.now()
                });
                console.log("ğŸ”¥ ì„œë²„ ì €ì¥ ì™„ë£Œ");
            } catch (e) { console.error("ğŸ”¥ ì €ì¥ ì‹¤íŒ¨:", e); }
        };

        // 2. ì „ì²´ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
        window.fetchRealRanking = async function() {
            const listDiv = document.getElementById('rank-list-national');
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                let html = '';
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = (doc.id === window.gameState.playerId);
                    const isMeClass = isMe ? 'my-rank' : '';
                    const rankClass = rank <= 3 ? 'top-3' : '';
                    const badge = rank <= 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1] : rank;
                    html += `<div class="rank-item ${isMeClass}"><div><span class="rank-badge ${rankClass}">${badge}</span><span style="font-weight:${isMe?'900':'normal'}">${data.name}</span></div><div style="font-family:monospace; font-weight:bold; color:#555;">${window.formatNum(data.score)} BPS</div></div>`;
                    rank++;
                });
                if(html === '') html = '<div style="padding:20px;">ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</div>';
                listDiv.innerHTML = html;
            } catch(e) {
                console.error("ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", e);
                listDiv.innerHTML = "âŒ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            }
        };

        // 3. ë‚´ ìˆœìœ„ ë¶ˆëŸ¬ì˜¤ê¸°
        window.fetchMyRank = async function() {
            if (!window.gameState.playerId) return;
            const myScore = window.gameState.baseBps * (window.gameState.isFever ? 10 : 1);
            
            try {
                const coll = collection(db, "leaderboard");
                const q = query(coll, where("score", ">", myScore));
                const snapshot = await getCountFromServer(q);
                const myRank = snapshot.data().count + 1; 

                const rankDiv = document.getElementById('mini-ranking');
                rankDiv.innerHTML = `ğŸ† í˜„ì¬ ${window.formatNum(myRank)} ë“±`;
            } catch(e) { 
                console.error("ë‚´ ìˆœìœ„ ë¡œë“œ ì‹¤íŒ¨", e); 
            }
        };

        window.fetchMyRank();
        setInterval(window.fetchMyRank, 30000); 

    } catch (e) {
        console.log("âš ï¸ Firebase ì—°ê²° ì‹¤íŒ¨ (ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤)", e);
    }
</script>
</body>
</html>
